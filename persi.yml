######################################################################################################################
###################################### GROUPS SECTION ################################################################
######################################################################################################################
groups:
- name: gorgophone
  jobs:
  - volman-unit
  - volman-unit-windows
  - volman-inigo
  - nfsdriver-unit
  - nfsbroker-unit
  - nfsdriver-certification
  - efsdriver-unit
  - efsbroker-unit
  - efsdriver-certification
  - csi-local-controller-plugin-unit
  - csi-local-node-plugin-unit
  - csi-local-node-plugin-unit-windows
  - csi-broker-unit
  - csi-plugin-certification
  - certification-test-builds
  - certification-test-publish
  - cifs-smbdriver-unit
  - cifs-smbdriver-unit-windows
  - cifs-azurefilebroker-unit
  - cifs-smbbroker-unit
  - cifs-existingvolumebroker-unit
  - ecs-broker-unit
  - localdriver-unit
  - localdriver-unit-windows
  - localbroker-unit
  - mapfs-unit
  - localdriver-certification
  - localdriver-certification-windows
  - localdriver-docker-certification
  - cifs-smbdriver-certification
  - cifs-smbdriver-certification-windows
  - deploy-smb-broker
  - create-local-volume-release
  - create-nfs-volume-release
  - create-efs-volume-release
  - create-csi-local-volume-release
  - create-csi-plugins-release
  - create-mapfs-release
  - create-diego-release
  - create-ecs-release
  - create-smb-volume-release
  - deploy-ecs-cluster
  - bbl-up-gorgophone
  - cf-deployment-nightly
  - deploy-cf
  - bbl-up-boshlite-aws
  - deploy-cf-efs
  - deploy-ecs-broker
  - deploy-nfs-brokers
  - migrate-nfs-broker
  - pats-nfs
  - pats-nfs-credhub
  - pats-efs
  - create-isilon-volume
  - pats-isilon
  - pats-nfs-docker
  - pats-nfs-ldap
  - pats-nfs-legacy
  - pats-nfs-ldap-legacy
  - pats-drats
  - pats-csi-local
  - pats-csi-nfs
  - pats-cifs-smb
  - pats-cifs-smb-windows
  - deploy-ecs-cluster
  - pats-ecs
  - pats-local
  - pats-local-windows
  - background-load-test

- name: csi
  jobs:
  - csi-local-controller-plugin-unit
  - csi-local-node-plugin-unit
  - csi-local-node-plugin-unit-windows
  - csi-plugin-certification
  - csi-broker-unit
  - mapfs-unit
  - pats-csi-local
  - pats-csi-nfs
  - create-csi-local-volume-release
  - create-csi-plugins-release
  - create-mapfs-release
  - bbl-up-gorgophone
  - deploy-cf
  - pats-drats

- name: nfs
  jobs:
  - nfsdriver-unit
  - nfsbroker-unit
  - nfsdriver-certification
  - nfsdriver-certification-async-v4
  - create-nfs-volume-release
  - pats-nfs
  - pats-nfs-docker
  - pats-nfs-ldap
  - pats-nfs-legacy
  - pats-nfs-ldap-legacy
  - pats-nfs-credhub
  - bbl-up-gorgophone
  - deploy-cf
  - deploy-nfs-brokers
  - migrate-nfs-broker
  - pats-drats
  - create-isilon-volume
  - pats-isilon
  - background-load-test

- name: efs
  jobs:
  - efsdriver-unit
  - efsbroker-unit
  - efsdriver-certification
  - create-efs-volume-release
  - bbl-up-boshlite-aws
  - deploy-cf-efs
  - pats-efs

- name: ecs
  jobs:
  - ecs-broker-unit
  - create-ecs-release
  - deploy-ecs-cluster
  - deploy-ecs-broker
  - bbl-up-gorgophone
  - deploy-cf
  - pats-ecs
  - pats-drats

- name: cifs
  jobs:
  - cifs-smbdriver-unit
  - cifs-smbdriver-unit-windows
  - cifs-azurefilebroker-unit
  - cifs-smbbroker-unit
  - cifs-existingvolumebroker-unit
  - create-smb-volume-release
  - cifs-smbdriver-certification
  - cifs-smbdriver-certification-windows
  - bbl-up-gorgophone
  - deploy-cf
  - deploy-smb-broker
  - pats-cifs-smb
  - pats-cifs-smb-windows
  - pats-drats

- name: local
  jobs:
  - localdriver-unit
  - localbroker-unit
  - localdriver-unit-windows
  - localdriver-certification
  - localdriver-certification-windows
  - localdriver-docker-certification
  - create-local-volume-release
  - pats-local
  - pats-local-windows
  - bbl-up-gorgophone
  - deploy-cf
  - pats-drats

- name: util
  jobs:
  - bbl-destroy

- name: release-nfs
  jobs:
  - shipit-nfs
  - manual-bump-nfs-patch
  - manual-bump-nfs-minor
  - manual-bump-nfs-major

- name: release-cifs-smb
  jobs:
  - shipit-smb
  - manual-bump-smb-patch
  - manual-bump-smb-minor
  - manual-bump-smb-major

- name: release-mapfs
  jobs:
  - shipit-mapfs
  - manual-bump-mapfs-patch
  - manual-bump-mapfs-minor
  - manual-bump-mapfs-major

###################################### END GROUPS SECTION ############################################################

######################################################################################################################
###################################### RESOURCES SECTION #############################################################
######################################################################################################################
resources:

#### Misc resources ###############################################################################################
- name: persi-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/persi-ci.git

- name: persi-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/persi-acceptance-tests.git

- name: bosh-bootloader
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-bootloader.git

- name: nightly
  type: time
  source:
    start: 12:00 AM
    stop: 1:00 AM
    location: America/Los_Angeles
#### END Misc resources ###############################################################################################

#### NFS resources ###############################################################################################
- name: nfs-volume-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: nfs-volume-release-tarballs
    regexp: nfs-volume-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}
- name: nfsvolume-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: nfsvolume-release-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: nfsvolume-final-release
  type: s3
  source:
    bucket: nfsvolume-final-releases
    regexp: nfs-volume-(.*).tgz
    access_key_id: {{nfsvolume-uploader_aws_ID}}
    secret_access_key: {{nfsvolume-uploader_aws_secret}}
- name: nfs-volume-release
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry/nfs-volume-release.git
    ignore_paths:
    - scripts
- name: nfs-volume-release-concourse-tasks
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry/nfs-volume-release.git
    paths:
    - scripts
- name: github-release-nfs
  type: github-release
  source:
    user: cloudfoundry
    repository: nfs-volume-release
    drafts: true
    access_token: {{github-release-token}}
- name: lib-nfs
  type: git
  source:
    branch: master
    uri: https://github.com/sahlberg/libnfs.git
- name: fuse-nfs
  type: git
  source:
    branch: master
    uri: https://github.com/sahlberg/fuse-nfs.git
#### END NFS resources ###############################################################################################

#### local volume resources ##########################################################################################
- name: local-volume-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: local-volume-release-tarballs
    regexp: local-volume-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}
- name: localvolume-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: localvolume-release-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: local-volume-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/local-volume-release.git
    ignore_paths:
    - scripts
- name: local-volume-release-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/local-volume-release.git
    paths:
    - scripts
#### END local volume resources ######################################################################################

#### EFS resources ################################################################################################
- name: efs-volume-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: efs-volume-release-tarballs
    regexp: efs-volume-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}
- name: efsvolume-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: efsvolume-release-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: efs-volume-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/efs-volume-release.git
    ignore_paths:
    - scripts
- name: efs-volume-release-concourse-tasks
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry-incubator/efs-volume-release.git
    paths:
    - scripts

#### END EFS resources ################################################################################################

#### Diego resources ################################################################################################
- name: diego-dev-release
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: persi-diego-dev-releases
    regexp: diego-0\.1476\.1-dev\.(\d+)\.tgz
    secret_access_key: {{aws-secret-access-key}}
- name: diego-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: persi-diego-release-versions
    initial_version: 9999.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: garden-runc-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release
# - name: garden-windows-release-tarball
#   type: bosh-io-release
#   source:
#     repository: cloudfoundry-incubator/garden-windows-bosh-release
- name: garden-runc-release-master
  type: git
  source:
    uri: https://github.com/cloudfoundry/garden-runc-release
    branch: master
- name: diego-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/diego-ci
- name: diego-release
  type: git
  source:
    branch: develop
    fetch:
    - develop
    ignore_paths:
    - dev_releases
    - git-hooks
    - releases
    - .final_builds
    uri: https://github.com/cloudfoundry/diego-release
- name: routing-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/routing-release.git
- name: routing-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release
#### End Diego resources ################################################################################################

#### Persi resources ################################################################################################
- name: deployments-persi
  type: git
  source:
    private_key: {{deployments-persi-key}}
    uri: git@github.com:cloudfoundry/deployments-persi.git
#### End Persi resources ################################################################################################

#### ECS resources ###################################################################################################
- name: ecs-release
  type: git
  source:
    uri: https://github.com/EMC-Dojo/ecs-release.git
- name: ecs-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: ecs-release-tarballs
    regexp: ecs-release-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}
- name: ecs-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: ecs-release-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: ecs-cf-service-broker
  type: git
  source:
    uri: https://github.com/codedellemc/ecs-cf-service-broker
#### End ECS resources ###############################################################################################

#### CSI resources ###################################################################################################
- name: csi-local-volume-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/csi-local-volume-release.git
    ignore_paths:
    - scripts

- name: csi-local-volume-release-concourse-tasks
  type: git
  source:
    uri: https://github.com/cloudfoundry/csi-local-volume-release.git
    paths:
    - scripts

- name: csi-cert
  type: git
  source:
    uri: https://github.com/paulcwarren/csi-cert

- name: csi-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: csi-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}

- name: csi-binaries
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    versioned_file: csi-cert.test.tgz
    bucket: csi-binaries
    secret_access_key: {{aws-secret-access-key}}

- name: csi-local-volume-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: csi-local-volume-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}

- name: csi-plugins-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: csi-plugins-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}

- name: csi-local-volume-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: csi-local-volume-release-tarballs
    regexp: csi-local-volume-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}

- name: csi-plugins-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: csi-plugins-release-tarballs
    regexp: csi-plugins-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}

- name: github-release-csi
  type: github-release
  source:
    user: paulcwarren
    repository: csi-cert
    drafts: true
    access_token: {{github-release-token}}

- name: csi-plugins-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/csi-plugins-release.git

#### End CSI resources ###############################################################################################

#### Start SMB resources ###############################################################################################
- name: smb-volume-release
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry/smb-volume-release.git
    ignore_paths:
    - scripts

- name: smb-volume-release-concourse-tasks
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry/smb-volume-release.git
    paths:
    - scripts

- name: smb-volume-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: smb-volume-release-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}

- name: smb-volume-release-tarball
  type: s3
  source:
    bucket: smb-volume-release-tarballs
    regexp: smb-volume-(.*).tgz
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}

- name: smbvolume-final-release
  type: s3
  source:
    bucket: smbvolume-final-releases
    regexp: smb-volume-(.*).tgz
    access_key_id: {{smbvolume-uploader_aws_ID}}
    secret_access_key: {{smbvolume-uploader_aws_secret}}

- name: github-release-smb
  type: github-release
  source:
    user: cloudfoundry
    repository: smb-volume-release
    drafts: true
    access_token: {{github-release-token}}

#### End SMB resources ###############################################################################################

#### mapfs resources ###################################################################################################

- name: mapfs-release-tarball
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: mapfs-release-tarballs
    regexp: mapfs-(.*).tgz
    secret_access_key: {{aws-secret-access-key}}
- name: mapfs-version
  type: semver
  source:
    access_key_id: {{aws-access-key-id}}
    bucket: mapfs-versions
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1
    secret_access_key: {{aws-secret-access-key}}
- name: mapfs-release
  type: git
  source:
    username: {{github-user}}
    password: {{github-password}}
    branch: master
    uri: https://github.com/cloudfoundry/mapfs-release.git
- name: github-release-mapfs
  type: github-release
  source:
    user: cloudfoundry
    repository: mapfs-release
    drafts: true
    access_token: {{github-release-token}}

#### End mapfs resources ###############################################################################################

#### cf-deployment resources #########################################################################################
- name: cf-deployment
  type: git
  source:
    branch: develop
    uri: https://github.com/julian-hj/cf-deployment.git

- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

- name: gorgophone-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/gorgophone-env.git
    private_key: {{deployments-persi-key}}

- name: gorgophone-env
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/gorgophone-env.git
    private_key: {{deployments-persi-key}}

- name: gorgophone-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/gorgophone-env.git
    private_key: {{deployments-persi-key}}
    paths:
    - deployment-vars.yml

- name: bbr-binary-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: bosh-backup-and-restore
    access_token: {{github-release-token}}

- name: disaster-recovery-acceptance-tests
  type: git
  source:
    uri: https://github.com/davewalter/disaster-recovery-acceptance-tests.git
    branch: add-smb-service-broker-testcase

#### End cf-deployment resources #####################################################################################

###################################### END RESOURCES SECTION #########################################################


######################################################################################################################
###################################### RESOURCE_TYPES SECTION ########################################################
######################################################################################################################
resource_types:
- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final
###################################### END RESOURCE_TYPES SECTION ####################################################


jobs:
#### Local Volume related jobs ########################################################################################
- name: localdriver-unit
  public: true
  plan:
  - aggregate:
    - get: local-volume-release-concourse-tasks
    - get: local-volume-release
      trigger: true
  - task: build
    file: local-volume-release-concourse-tasks/scripts/ci/run_driver_unit.build.yml

- name: localdriver-unit-windows
  public: true
  plan:
  - aggregate:
    - get: local-volume-release-concourse-tasks
    - get: local-volume-release
      trigger: true
  - task: build
    file: local-volume-release-concourse-tasks/scripts/ci/run_driver_unit_windows.build.yml

- name: localbroker-unit
  public: true
  plan:
  - aggregate:
    - get: local-volume-release-concourse-tasks
    - get: local-volume-release
      trigger: true
  - task: build
    file: local-volume-release-concourse-tasks/scripts/ci/run_broker_unit.build.yml

- name: localdriver-certification
  plan:
  - aggregate:
    - get: local-volume-release
      passed:
      - localdriver-unit
      trigger: true
    - get: local-volume-release-concourse-tasks
  - task: build
    file: local-volume-release-concourse-tasks/scripts/ci/run_driver_cert.build.yml

- name: localdriver-certification-windows
  plan:
  - aggregate:
    - get: local-volume-release
      passed:
      - localdriver-unit-windows
      trigger: true
    - get: local-volume-release-concourse-tasks
  - task: build
    file: local-volume-release-concourse-tasks/scripts/ci/run_driver_cert_windows.build.yml

- name: localdriver-docker-certification
  plan:
  - aggregate:
    - get: local-volume-release
      passed:
      - localdriver-unit
      trigger: true
    - get: local-volume-release-concourse-tasks
  - task: build
    privileged: true
    file: local-volume-release-concourse-tasks/scripts/ci/run_docker_cert.build.yml

- name: create-local-volume-release
  plan:
  - aggregate:
    - get: local-volume-release
      passed:
      - localdriver-certification
      - localdriver-docker-certification
      - localbroker-unit
      trigger: true
    - get: local-volume-version
      resource: localvolume-version
      params:
        pre: rc
    - get: local-volume-release-concourse-tasks
  - put: local-volume-version
    resource: localvolume-version
    params:
      file: local-volume-version/number
  - task: create-release
    file: local-volume-release-concourse-tasks/scripts/ci/create_local_volume_release.build.yml
  - put: local-volume-release-tarball
    params:
      file: created-local-volume-release/local*.tgz

- name: pats-local
  serial_groups:
  - local
  plan:
  - aggregate:
    - get: diego-dev-release
      passed: [ deploy-cf ]
      trigger: true
    - get: diego-release
    - get: local-volume-release
      passed:
      - deploy-cf
      trigger: true
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: local-volume-release-concourse-tasks
  - task: run-pats
    file: local-volume-release-concourse-tasks/scripts/ci/run_pats_localvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://local-broker.gorgophone.cf-app.com
      BROKER_USER: {{pats-broker-username}}
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: free-local-dist
      SERVICE_NAME: local-volume
      TEST_MULTI_CELL: false
      TEST_MOUNT_OPTIONS: false

- name: pats-local-windows
  serial_groups:
  - local
  plan:
  - aggregate:
    - get: diego-dev-release
      passed: [ deploy-cf ]
      trigger: true
    - get: diego-release
    - get: local-volume-release
      passed:
      - deploy-cf
      trigger: true
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: local-volume-release-concourse-tasks
  - task: run-pats
    file: local-volume-release-concourse-tasks/scripts/ci/run_pats_localvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://local-broker.gorgophone.cf-app.com
      BROKER_USER: {{pats-broker-username}}
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: free-local-dist
      SERVICE_NAME: local-volume
      TEST_MULTI_CELL: false
      TEST_MOUNT_OPTIONS: false
      TEST_WINDOWS_CELL: true

#### END Local volume #################################################################################################

#### NFS related jobs #################################################################################################
- name: nfsdriver-unit
  public: true
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      trigger: true
  - task: build
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_driver_unit.build.yml
- name: nfsbroker-unit
  public: true
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      trigger: true
  - task: build
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_broker_unit.build.yml
- name: nfsdriver-certification
  serial_groups:
  - nfs-test-server
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - create-nfs-volume-release
      trigger: true
    - get: lib-nfs
    - get: fuse-nfs
  - task: fuse-nfs-cert
    privileged: true
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_fuse_nfs_cert.build.yml
    params:
      FUSE_MOUNT: nfs://nfstestserver.gorgophone.cf-app.com/export2/certs?uid=3000&gid=3050
      NFS_MOUNT: nfstestserver.gorgophone.cf-app.com:/export2/certs
  - task: driver-cert
    privileged: true
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_driver_cert_tcp.build.yml
    params:
      SOURCE: nfs://nfstestserver.gorgophone.cf-app.com/export2/certs
  - task: experimental-driver-cert
    privileged: true
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_driver_cert_experimental.build.yml
    params:
      SOURCE: nfs://nfstestserver.gorgophone.cf-app.com/export2/certs
- name: nfsdriver-certification-async-v4
  serial_groups:
  - nfs-test-server
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - create-nfs-volume-release
    - get: lib-nfs
      trigger: true
    - get: fuse-nfs
      trigger: true
  - task: fuse-nfs-cert
    privileged: true
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_fuse_nfs_cert.build.yml
    input_mapping:
      fuse-nfs: fuse-nfs
    params:
      FUSE_MOUNT: nfs://nfstestserver.gorgophone.cf-app.com/export2/certs?uid=3000&gid=3050&multithread=1
      NFS_MOUNT: nfstestserver.gorgophone.cf-app.com:/export2/certs
  - task: driver-cert
    privileged: true
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_driver_cert_tcp.build.yml
    input_mapping:
      fuse-nfs: fuse-nfs
    params:
      SOURCE: nfs://nfstestserver.gorgophone.cf-app.com/export2/certs?version=4
      MULTITHREAD: 1
- name: create-nfs-volume-release
  serial_groups:
  - nfs-version
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - nfsdriver-unit
      - nfsbroker-unit
      trigger: true
    - get: nfs-volume-version
      resource: nfsvolume-version
      params:
        pre: rc
  - put: nfs-volume-version
    resource: nfsvolume-version
    params:
      file: nfs-volume-version/number
  - task: create-release
    file: nfs-volume-release-concourse-tasks/scripts/ci/create_nfs_volume_release.build.yml
  - put: nfs-volume-release-tarball
    params:
      file: created-nfs-volume-release/nfs*.tgz
- name: shipit-nfs
  serial_groups:
  - nfs-version
  plan:
  - aggregate:
    - get: persi-ci
    - get: release-tarball
      resource: nfs-volume-release-tarball
      passed:
      - pats-nfs
    - get: release
      resource: nfs-volume-release
      passed:
      - pats-nfs
    - get: version
      resource: nfsvolume-version
      params:
        bump: final
  - task: finalize-release
    file: persi-ci/scripts/ci/finalize_release.build.yml
    params:
      BASE_RELEASE_NAME: nfs-volume
      GIT_USER: {{github-user}}
      GIT_EMAIL: {{github-email}}
      S3_ACCESS_KEY_ID: {{nfsvolume-uploader_aws_ID}}
      S3_ACCESS_KEY: {{nfsvolume-uploader_aws_secret}}
  - aggregate:
    - put: nfs-volume-version
      resource: nfsvolume-version
      params:
        file: version/number
    - put: nfsvolume-final-release
      params:
        file: finalized-release/nfs-volume-*.tgz
  - task: generate-release
    file: persi-ci/scripts/ci/generate_github_release.build.yml
    params:
      BASE_RELEASE_NAME: nfs-volume
    input_mapping:
      volume-release: release
      volume-version: version
  - put: nfs-volume-release
    params:
      repository: finalized-release/release
      tag: version/number
      tag_prefix: v
  - put: github-release-nfs
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs: []
      # - nfsvolume-final-release/*.tgz
  - put: nfsvolume-version
    params:
      bump: patch
- name: manual-bump-nfs-patch
  serial_groups:
  - nfs-version
  plan:
  - get: nfs-volume-version
    resource: nfsvolume-version
    params:
      bump: final
  - put: nfsvolume-version
    params:
      bump: patch
- name: manual-bump-nfs-minor
  serial_groups:
  - nfs-version
  plan:
  - get: nfs-volume-version
    resource: nfsvolume-version
    params:
      bump: final
  - put: nfsvolume-version
    params:
      bump: minor
- name: manual-bump-nfs-major
  serial_groups:
  - nfs-version
  plan:
  - get: nfs-volume-version
    resource: nfsvolume-version
    params:
      bump: final
  - put: nfsvolume-version
    params:
      bump: major

- name: shipit-mapfs
  serial_groups:
  - mapfs-version
  plan:
  - aggregate:
    - get: persi-ci
    - get: release-tarball
      resource: mapfs-release-tarball
      passed:
      - pats-nfs-legacy
    - get: release
      resource: mapfs-release
      passed:
      - pats-nfs-legacy
    - get: version
      resource: mapfs-version
      params:
        bump: final
  - task: finalize-release
    file: persi-ci/scripts/ci/finalize_release.build.yml
    params:
      BASE_RELEASE_NAME: mapfs
      GIT_USER: {{github-user}}
      GIT_EMAIL: {{github-email}}
      S3_ACCESS_KEY_ID: {{aws-access-key-id}}
      S3_ACCESS_KEY: {{aws-secret-access-key}}
  - aggregate:
    - put: version
      resource: mapfs-version
      params:
        file: version/number
  - task: generate-release
    file: persi-ci/scripts/ci/generate_github_release.build.yml
    params:
      BASE_RELEASE_NAME: mapfs
  - put: mapfs-release
    params:
      repository: finalized-release/release
      tag: version/number
      tag_prefix: v
  - put: github-release-mapfs
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs: []
  - put: mapfs-version
    params:
      bump: patch
- name: manual-bump-mapfs-patch
  serial_groups:
  - mapfs-version
  plan:
  - get: version
    resource: mapfs-version
    params:
      bump: final
  - put: mapfs-version
    params:
      bump: patch
- name: manual-bump-mapfs-minor
  serial_groups:
  - mapfs-version
  plan:
  - get: version
    resource: mapfs-version
    params:
      bump: final
  - put: mapfs-version
    params:
      bump: minor
- name: manual-bump-mapfs-major
  serial_groups:
  - mapfs-version
  plan:
  - get: version
    resource: mapfs-version
    params:
      bump: final
  - put: mapfs-version
    params:
      bump: major

- name: deploy-nfs-brokers
  serial_groups:
  - nfs
  - errands
  plan:
  - aggregate:
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: nfs-volume-release
      passed: [ deploy-cf ]
      trigger: true
    - get: cf-deployment
      passed: [ deploy-cf ]
      trigger: true
  - task: run-broker-errand
    file: persi-ci/scripts/ci/run_nfs_broker_errand.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      ERRAND_NAME: nfsbrokerpush
      INSTANCE_NAME: nfs-broker-push/first
  - task: run-credhub-broker-errand
    file: persi-ci/scripts/ci/run_nfs_broker_errand.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      ERRAND_NAME: nfsbrokerpush
      INSTANCE_NAME: nfs-broker-credhub-push/first

- name: migrate-nfs-broker
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: nfs-volume-release
      passed:
      - pats-nfs
      trigger: true
    - get: gorgophone-env-vars-store
  - task: run-migration-test
    file: persi-ci/scripts/ci/migrate_nfs_broker_to_credhub.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USER: admin
      SERVICE_BROKER_NAME: nfs-broker-migration-test
      BROKER_PASSWORD_KEY: nfs-broker-migration-test-password
      BROKER_APP_URL: http://nfs-broker-migration-test.gorgophone.cf-app.com
      CREATE_CONFIG: '{"share":"nfstestserver.service.cf.internal/export/users"}'
      BIND_CONFIG: '{"uid":"1000","gid":"1000"}'

- name: pats-nfs
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      CREATE_BOGUS_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/nonexistensevol\"}'
      BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      BIND_BOGUS_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: true
      TEST_READ_ONLY: true
      TEST_MOUNT_FAIL_LOGGING: true

- name: pats-nfs-credhub
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs-credhub
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: true
      TEST_READ_ONLY: true

- name: pats-nfs-legacy
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: mapfs-release
      passed:
      - deploy-cf
    - get: mapfs-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs-legacy
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      CREATE_BOGUS_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/nonexistensevol\"}'
      BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      BIND_BOGUS_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: true
      TEST_READ_ONLY: true
      TEST_MOUNT_FAIL_LOGGING: true

- name: pats-nfs-docker
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: true
      TEST_READ_ONLY: true
      TEST_DOCKER_PORA: true

- name: pats-nfs-ldap
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      BIND_CONFIG: '{\"username\":\"user1000\",\"password\":\"secret\"}'
      DISALLOWED_LDAP_BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false
      TEST_READ_ONLY: false
      TEST_DOCKER_PORA: true
      TEST_ISOLATION_SEGMENT: ldap

- name: pats-nfs-ldap-legacy
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: nfs-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs-legacy
      CREATE_CONFIG: '{\"share\":\"nfstestserver.service.cf.internal/export/users\"}'
      BIND_CONFIG: '{\"username\":\"user1000\",\"password\":\"secret\"}'
      DISALLOWED_LDAP_BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false
      TEST_READ_ONLY: false
      TEST_DOCKER_PORA: true
      TEST_ISOLATION_SEGMENT: ldap

- name: background-load-test
  serial_groups:
  - nfs
  plan:
  - aggregate:
    - get: nightly
      trigger: true
    - get: persi-ci
    - get: persi-acceptance-tests
    - get: gorgophone-env-director-state
  - task: run-test
    file: persi-ci/scripts/ci/run_background_load_test.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      CF_USERNAME: admin
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      APPS_DOMAIN: gorgophone.cf-app.com
      CREATE_CONFIG: '{"share":"nfstestserver.service.cf.internal/export/users"}'
      BIND_CONFIG: '{"uid":"1000","gid":"1000"}'

#### END NFS #########################################################################################################

#### Isilon related jobs #############################################################################################
- name: create-isilon-volume
  serial_groups:
  - isilon
  plan:
  - aggregate:
    - get: nfs-volume-release
      passed:
      - deploy-cf
      trigger: true
    - get: persi-ci
    - get: deployments-persi
    - get: gorgophone-env-director-state
  - task: create-share
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_IAAS: gcp
      BBL_STATE_DIR: bbl-state-gcp
    file: deployments-persi/persi-ci/deployments/isilon-volume/create-share.build.yml

- name: pats-isilon
  serial_groups:
  - nfs
  - isilon
  plan:
  - aggregate:
    - get: nfs-volume-release-concourse-tasks
    - get: persi-ci
    - get: nfs-volume-release
      passed:
      - create-isilon-volume
      - deploy-nfs-brokers
      trigger: true
    - get: gorgophone-env-vars-store
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-vars-store
    params:
      BBL_IAAS: gcp
      BBL_STATE_DIR: bbl-state-gcp
      APPLICATION_PATH: nfs-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://nfs-broker.gorgophone.cf-app.com
      BROKER_USER: nfs-broker
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      SERVICE_NAME: nfs
      CREATE_CONFIG: '{\"share\":\"isilon.persi.cf-app.com/ifs/persi-pats\"}'
      BIND_CONFIG: '{\"uid\":\"1000\",\"gid\":\"1000\"}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false
      TEST_READ_ONLY: true
#### END Isilon ######################################################################################################

#### EFS related jobs ################################################################################################
- name: efsdriver-unit
  public: true
  plan:
  - aggregate:
    - get: efs-volume-release-concourse-tasks
    - get: efs-volume-release
      trigger: true
  - task: build
    file: efs-volume-release-concourse-tasks/scripts/ci/run_driver_unit.build.yml
- name: efsbroker-unit
  public: true
  plan:
  - aggregate:
    - get: efs-volume-release-concourse-tasks
    - get: efs-volume-release
      trigger: true
  - task: build
    file: efs-volume-release-concourse-tasks/scripts/ci/run_broker_unit.build.yml
- name: efsdriver-certification
  plan:
  - aggregate:
    - get: efs-volume-release-concourse-tasks
    - get: efs-volume-release
      passed:
      - efsdriver-unit
      - efsbroker-unit
      trigger: true
  - task: build
    tags: ["jumpbox"]
    privileged: true
    file: efs-volume-release-concourse-tasks/scripts/ci/run_driver_cert.build.yml
- name: create-efs-volume-release
  plan:
  - aggregate:
    - get: efs-volume-release-concourse-tasks
    - get: efs-volume-release
      passed:
      - efsdriver-certification
      trigger: true
    - get: efs-volume-version
      resource: efsvolume-version
      params:
        pre: rc
  - put: efs-volume-version
    resource: efsvolume-version
    params:
      file: efs-volume-version/number
  - task: create-release
    file: efs-volume-release-concourse-tasks/scripts/ci/create_efs_volume_release.build.yml
  - put: efs-volume-release-tarball
    params:
      file: created-efs-volume-release/efs*.tgz

- name: pats-efs
  serial_groups:
  - efs
  plan:
  - aggregate:
    - get: deployments-persi
    - get: efs-volume-release-concourse-tasks
    - get: efs-volume-release
      passed:
      - deploy-cf-efs
      trigger: true
    - get: efs-volume-release-tarball
      passed:
      - deploy-cf-efs
    - get: diego-dev-release
      passed: [ deploy-cf-efs ]
      trigger: true
    - get: gorgophone-env-director-state

  - task: run-pats
    file: efs-volume-release-concourse-tasks/scripts/ci/run_pats_efsvolume_bosh_lite.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-boshlite-aws
      APPLICATION_PATH: efs-volume-release/assets/pora
      BROKER_USER: {{pats-broker-username}}
      CF_USERNAME: {{cf-bosh-lite-username}}
      PLAN_NAME: generalPurpose
      SERVICE_NAME: efs
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false
      DEFAULT_TIMEOUT: 300
      ELASTIC_IP: 34.213.225.99

#### END EFS ##########################################################################################################


#### CF related jobs ##################################################################################################
- name: volman-unit
  public: true
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: persi-ci
  - task: run-unit
    file: persi-ci/scripts/ci/run_volman_unit.build.yml

- name: volman-unit-windows
  public: true
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: persi-ci
  - task: run-unit-windows
    file: persi-ci/scripts/ci/run_volman_unit_windows.build.yml

- name: volman-inigo
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
    - get: persi-ci
  - task: garden-runc-release
    file: diego-ci/concourse/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/concourse/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: persi-ci/scripts/ci/run_volman_inigo.build.yml
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      GINKGO_PARALLEL: false

- name: create-diego-release
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
      passed:
      - volman-unit
      - volman-inigo
    - get: persi-ci
    - get: version
      resource: diego-version
      params:
        pre: dev
  - put: version
    resource: diego-version
    params:
      file: version/number
  - task: create-release
    file: persi-ci/scripts/ci/create_diego_dev_release.build.yml
  - put: diego-dev-release
    params:
      file: created-diego-release/diego-*.tgz

#### END CF ###########################################################################################################

#### START ECS related jobs ###########################################################################################
- name: create-ecs-release
  plan:
  - aggregate:
    - get: ecs-release
      trigger: true
    - get: persi-ci
    - get: ecs-version
      resource: ecs-version
      params:
        pre: rc
  - put: ecs-version
    resource: ecs-version
    params:
      file: ecs-version/number
  - task: create-release
    file: persi-ci/scripts/ci/create_ecs_release.build.yml
  - put: ecs-release-tarball
    params:
      file: created-ecs-release/ecs*.tgz

- name: ecs-broker-unit
  public: true
  plan:
  - aggregate:
    - get: persi-ci
    - get: ecs-cf-service-broker
      trigger: true
  - task: ecs-broker-unit
    file: persi-ci/scripts/ci/ecs_broker_unit.build.yml

- name: deploy-ecs-cluster
  serial_groups:
  - ecs-deploy
  plan:
  - aggregate:
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: gorgophone-env
    - get: ecs-bosh-release
      passed:
      - create-ecs-release
      trigger: true
      resource: ecs-release
    - get: ecs-release-tarball
      passed:
      - create-ecs-release
  - task: bosh-deploy-ecs
    file: persi-ci/scripts/ci/deploy-ecs.yml
    input_mapping:
      vars-store: gorgophone-env
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp

- name: deploy-ecs-broker
  serial_groups:
  - ecs-deploy
  - errands
  plan:
  - aggregate:
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: ecs-version
      passed: [ deploy-cf ]
      trigger: true
    - get: cf-deployment
      passed: [ deploy-cf ]
      trigger: true
  - task: run-broker-errand
    file: persi-ci/scripts/ci/run_ecs_broker_errand_cf_deployment.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp

- name: pats-ecs
  serial_groups:
  - ecs-deploy
  plan:
  - aggregate:
    - get: ecs-version
      passed:
      - deploy-ecs-broker
      trigger: true
    - get: nfs-volume-release-concourse-tasks
    - get: nfs-volume-release
    - get: gorgophone-env-vars-store
    - get: persi-ci
  - task: run-pats
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_pats_nfsvolume.build.yml
    input_mapping:
      vars-store: gorgophone-env-vars-store
    params:
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://ecs-v1.gorgophone.cf-app.com
      BROKER_USER: user
      BROKER_PASSWORD_KEY: ecs-broker-password
      CF_USERNAME: admin
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      PLAN_NAME: 5gb
      SERVICE_NAME: ecs-file-bucket
      BIND_CONFIG: '{}'
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false
      TEST_READ_ONLY: false

#### END ECS ##########################################################################################################

#### START CSI related jobs ###########################################################################################
- name: csi-local-controller-plugin-unit
  public: true
  plan:
  - aggregate:
    - get: csi-local-volume-release
      trigger: true
    - get: csi-local-volume-release-concourse-tasks
  - task: local-controller-plugin-unit
    file: csi-local-volume-release-concourse-tasks/scripts/ci/local-controller-plugin-unit.build.yml

- name: csi-local-node-plugin-unit
  public: true
  plan:
  - aggregate:
    - get: csi-local-volume-release
      trigger: true
    - get: csi-local-volume-release-concourse-tasks
  - task: local-node-plugin-unit
    file: csi-local-volume-release-concourse-tasks/scripts/ci/local-node-plugin-unit.build.yml

- name: csi-local-node-plugin-unit-windows
  public: true
  plan:
  - aggregate:
    - get: csi-local-volume-release
      trigger: true
    - get: csi-local-volume-release-concourse-tasks
  - task: local-node-plugin-unit-windows
    file: csi-local-volume-release-concourse-tasks/scripts/ci/local-node-plugin-unit-windows.build.yml

- name: csi-broker-unit
  public: true
  plan:
  - aggregate:
    - get: csi-local-volume-release
      trigger: true
    - get: csi-local-volume-release-concourse-tasks
  - task: csi-broker-unit
    file: csi-local-volume-release-concourse-tasks/scripts/ci/csi-broker-unit.build.yml

- name: csi-plugin-certification
  plan:
  - aggregate:
    - get: csi-local-volume-release
      passed:
      - csi-local-controller-plugin-unit
      - csi-local-node-plugin-unit
      trigger: true
    - get: csi-cert
      trigger: true
    - get: csi-local-volume-release-concourse-tasks
  - task: csi-plugin-certification
    privileged: true
    file: csi-local-volume-release-concourse-tasks/scripts/ci/csi-plugin-certification.build.yml

- name: certification-test-builds
  plan:
  - aggregate:
    - get: csi-local-volume-release
      passed:
      - csi-plugin-certification
      trigger: true
    - get: csi-cert
      passed:
      - csi-plugin-certification
      trigger: true
  - task: certificate-test-build
    file: csi-cert/scripts/ci/certificate-test-build.build.yml
  - put: csi-binaries
    params:
      file: binaries/csi-cert.test.tgz

- name: certification-test-publish
  plan:
  - aggregate:
    - get: persi-ci
    - get: volume-version
      resource: csi-version
    - get: csi-binaries
    - get: volume-release
      resource: csi-cert
      passed:
      - certification-test-builds

  - task: generate-release
    file: persi-ci/scripts/ci/generate_csi_github_release.build.yml
    params:
      VERSION: csi-version
      RELEASE: csi-cert
      BASE_RELEASE_NAME: csi-cert

  - put: github-release-csi
    params:
      name: generated-release/name
      tag: generated-release/version
      globs:
      - csi-binaries/*.tgz

  - put: csi-version
    params:
      bump: minor

- name: create-csi-plugins-release
  plan:
  - aggregate:
    - get: csi-plugins-release
#      passed:
#      - TODO: add unit and certification test
      trigger: true
    - get: csi-plugins-version
      resource: csi-plugins-version
      params:
        pre: rc

  - put: csi-plugins-version
    resource: csi-plugins-version
    params:
      file: csi-plugins-version/number

  - task: generate-release
    file: csi-plugins-release/scripts/ci/create_release.build.yml

  - put: csi-plugins-release-tarball
    params:
      file: created-plugins-release/csi*.tgz

- name: mapfs-unit
  public: true
  plan:
  - get: mapfs-release
    trigger: true
  - task: run-unit
    file: mapfs-release/scripts/ci/run_tests.build.yml

- name: create-mapfs-release
  plan:
  - aggregate:
    - get: mapfs-release
      passed:
      - mapfs-unit
      trigger: true
    - get: mapfs-version
      resource: mapfs-version
      params:
        pre: rc

  - put: mapfs-version
    resource: mapfs-version
    params:
      file: mapfs-version/number

  - task: generate-release
    file: mapfs-release/scripts/ci/create_release.build.yml

  - put: mapfs-release-tarball
    params:
      file: created-plugins-release/mapfs*.tgz

- name: create-csi-local-volume-release
  plan:
  - aggregate:
    - get: csi-local-volume-release
      passed:
      - csi-plugin-certification
      - csi-broker-unit
      trigger: true
    - get: csi-local-version
      resource: csi-local-volume-version
      params:
        pre: rc
    - get: csi-local-volume-release-concourse-tasks

  - put: csi-local-version
    resource: csi-local-volume-version
    params:
      file: csi-local-version/number

  - task: generate-release
    file: csi-local-volume-release-concourse-tasks/scripts/ci/create_release.build.yml

  - put: csi-local-volume-release-tarball
    params:
      file: created-csi-local-volume-release/csi*.tgz

- name: pats-csi-local
  serial_groups:
  - csi-local
  plan:
  - aggregate:
    - get: csi-local-volume-release
      passed:
      - deploy-cf
      trigger: true
    - get: diego-dev-release
      passed: [ deploy-cf ]
      trigger: true
    - get: diego-release
    - get: csi-local-volume-release-tarball
      passed:
      - deploy-cf
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: csi-local-volume-release-concourse-tasks

  - task: run-pats
    file: csi-local-volume-release-concourse-tasks/scripts/ci/run_pats_localvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPS_DOMAIN: gorgophone.cf-app.com
      BIND_CONFIG: '{\"mount\":\"/var/vcap/store\"}'
      BROKER_URL: http://csi-localbroker.gorgophone.cf-app.com
      BROKER_USER: csi-localbroker
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: free
      CREATE_CONFIG: '{\"name\":\"csi-local-storage\",\"volume_capabilities\":[{\"mount\":{}}]}'
      SERVICE_NAME: csilocalfs
      TEST_MULTI_CELL: false
      TEST_MOUNT_OPTIONS: false

- name: pats-csi-nfs
  serial_groups:
  - csi-nfs
  plan:
  - aggregate:
    - get: persi-ci
    - get: csi-plugins-release
      passed: [ deploy-cf ]
      trigger: true
    - get: diego-dev-release
      passed: [ deploy-cf ]
      trigger: true
    - get: diego-release
    - get: csi-plugins-release-tarball
      passed:
      - deploy-cf
    - get: gorgophone-env-director-state

  - task: run-pats
    file: csi-plugins-release/scripts/ci/run_pats_nfs.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      #TODO: add uid/gid bind config and use /export/users endpoint
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      APPS_DOMAIN: gorgophone.cf-app.com
      BIND_CONFIG:
      BROKER_URL: http://csi-nfsbroker.gorgophone.cf-app.com
      BROKER_USER: csi-nfsbroker
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: free
      CREATE_CONFIG: '{\"name\":\"csi-nfs-storage\",\"volume_capabilities\":[{\"mount\":{}}],\"parameters\":{\"server\":\"nfstestserver.service.cf.internal\",\"share\":\"/export/users2000\"}}'
      SERVICE_NAME: csi-nfs
      TEST_MULTI_CELL: true
      TEST_MOUNT_OPTIONS: false


#### END CSI related jobs ############################################################################################

#### START SMB related jobs ###########################################################################################
- name: cifs-smbdriver-unit
  public: true
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
  - task: smbdriver-unit
    file: smb-volume-release-concourse-tasks/scripts/ci/run-submodule-unit.build.yml
    params:
      SUBMODULE_NAME: smbdriver

- name: cifs-smbdriver-unit-windows
  public: true
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
  - task: smbdriver-unit
    file: smb-volume-release-concourse-tasks/scripts/ci/smbdriver-unit-windows.build.yml

- name: cifs-azurefilebroker-unit
  public: true
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
  - task: azurefilebroker-unit
    file: smb-volume-release-concourse-tasks/scripts/ci/run-submodule-unit.build.yml
    params:
      SUBMODULE_NAME: azurefilebroker

- name: cifs-smbbroker-unit
  public: true
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
  - task: smbbroker-unit
    file: smb-volume-release-concourse-tasks/scripts/ci/run-submodule-unit.build.yml
    params:
      SUBMODULE_NAME: smbbroker

- name: cifs-existingvolumebroker-unit
  public: true
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
  - task: existingvolumebroker-unit
    file: smb-volume-release-concourse-tasks/scripts/ci/run-submodule-unit.build.yml
    params:
      SUBMODULE_NAME: existingvolumebroker

- name: create-smb-volume-release
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      passed:
      - cifs-azurefilebroker-unit
      - cifs-smbbroker-unit
      - cifs-existingvolumebroker-unit
      - cifs-smbdriver-unit
      - cifs-smbdriver-unit-windows
      trigger: true
    - get: smb-volume-version
      resource: smb-volume-version
      params:
        pre: rc
  - put: smb-volume-version
    resource: smb-volume-version
    params:
      file: smb-volume-version/number
  - task: create-release
    file: smb-volume-release-concourse-tasks/scripts/ci/create_smb_volume_release.build.yml
  - put: smb-volume-release-tarball
    params:
      file: created-smb-volume-release/smb-volume-*.tgz

- name: cifs-smbdriver-certification
  serial_groups:
  - smb
  plan:
  - aggregate:
    - get: persi-ci
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      passed:
      - deploy-cf
      trigger: true
    - get: gorgophone-env-director-state
  - task: driver-cert
    privileged: true
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      username: {{smb_server_username}}
      password: {{smb_server_password}}
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
    file: smb-volume-release-concourse-tasks/scripts/ci/run_driver_cert.build.yml

- name: cifs-smbdriver-certification-windows
  serial_groups:
  - smb
  plan:
  - aggregate:
    - get: persi-ci
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      passed:
      - deploy-cf
      trigger: true
  - task: driver-cert
    privileged: true
    params:
      smbremotepath: {{azure_remote_path_windows}}
      smbusername: {{azure_username_windows}}
      smbpassword: {{azure_password_windows}}
    file: smb-volume-release-concourse-tasks/scripts/ci/run_driver_cert_windows.build.yml

- name: deploy-smb-broker
  serial_groups:
  - smb
  - errands
  plan:
  - aggregate:
    - get: persi-ci
    - get: gorgophone-env-director-state
    - get: smb-volume-release
      passed: [ deploy-cf ]
      trigger: true
    - get: cf-deployment
      passed: [ deploy-cf ]
      trigger: true
  - task: run-broker-errand
    file: persi-ci/scripts/ci/run_nfs_broker_errand.build.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      ERRAND_NAME: smbbrokerpush
      INSTANCE_NAME: smb-broker-push/first

- name: pats-cifs-smb
  serial_groups:
  - smb
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      passed:
      - cifs-smbdriver-certification
      - cifs-smbdriver-certification-windows
      - deploy-smb-broker
      trigger: true
    - get: smb-volume-release-tarball
      passed:
      - deploy-cf
    - get: gorgophone-env-vars-store
    - get: persi-ci

  - task: run-pats
    file: smb-volume-release-concourse-tasks/scripts/ci/run_pats_smbvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-vars-store
    params:
      BBL_IAAS: gcp
      BBL_STATE_DIR: bbl-state-gcp
      APPLICATION_PATH: smb-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://azurefilebroker.gorgophone.cf-app.com
      BROKER_USER: admin
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      PLAN_NAME: Existing
      AZURE_REMOTE_PATH: {{azure_remote_path}}
      AZURE_USERNAME: {{azure_username}}
      AZURE_PASSWORD: {{azure_password}}
      SERVICE_NAME: azurefile-service
      TEST_MULTI_CELL: false
      TEST_MOUNT_OPTIONS: false

- name: pats-cifs-smb-windows
  serial_groups:
  - smb
  plan:
  - aggregate:
    - get: smb-volume-release-concourse-tasks
    - get: smb-volume-release
      trigger: true
      passed:
      - deploy-cf
      - deploy-smb-broker
    - get: smb-volume-release-tarball
      passed:
      - deploy-cf
    - get: gorgophone-env-vars-store
    - get: persi-ci
  - task: run-pats
    file: smb-volume-release-concourse-tasks/scripts/ci/run_pats_smbvolume.build.yml
    input_mapping:
      director-state: gorgophone-env-vars-store
    params:
      BBL_IAAS: gcp
      BBL_STATE_DIR: bbl-state-gcp
      APPLICATION_PATH: smb-volume-release/assets/pora
      APPS_DOMAIN: gorgophone.cf-app.com
      BROKER_URL: http://azurefilebroker.gorgophone.cf-app.com
      BROKER_USER: admin
      SERVICE_NAME: azurefile-service
      PLAN_NAME: Existing
      AZURE_REMOTE_PATH: {{azure_remote_path_windows}}
      AZURE_USERNAME: {{azure_username_windows}}
      AZURE_PASSWORD: {{azure_password_windows}}
      CF_API_ENDPOINT: api.gorgophone.cf-app.com
      CF_USERNAME: admin
      TEST_MULTI_CELL: false
      TEST_MOUNT_OPTIONS: false
      TEST_WINDOWS_CELL: true

- name: shipit-smb
  serial_groups:
  - smb-version
  plan:
  - aggregate:
    - get: persi-ci
    - get: release-tarball
      resource: smb-volume-release-tarball
      passed:
      - pats-cifs-smb
    - get: release
      resource: smb-volume-release
      passed:
      - pats-cifs-smb
    - get: version
      resource: smb-volume-version
      params:
        bump: final
  - task: finalize-release
    file: persi-ci/scripts/ci/finalize_release.build.yml
    params:
      BASE_RELEASE_NAME: smb-volume
      GIT_USER: {{github-user}}
      GIT_EMAIL: {{github-email}}
      S3_ACCESS_KEY_ID: {{smbvolume-uploader_aws_ID}}
      S3_ACCESS_KEY: {{smbvolume-uploader_aws_secret}}
  - aggregate:
    - put: smb-volume-version
      resource: smb-volume-version
      params:
        file: version/number
    - put: smbvolume-final-release
      params:
        file: finalized-release/smb-volume-*.tgz
  - task: generate-release
    file: persi-ci/scripts/ci/generate_github_release.build.yml
    params:
      BASE_RELEASE_NAME: smb-volume
  - put: smb-volume-release
    params:
      repository: finalized-release/release
      tag: version/number
      tag_prefix: v
  - put: github-release-smb
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs: []
  - put: smb-volume-version
    params:
      bump: patch
- name: manual-bump-smb-patch
  serial_groups:
  - smb-version
  plan:
  - get: smb-volume-version
    resource: smb-volume-version
    params:
      bump: final
  - put: smb-volume-version
    params:
      bump: patch
- name: manual-bump-smb-minor
  serial_groups:
  - smb-version
  plan:
  - get: smb-volume-version
    resource: smb-volume-version
    params:
      bump: final
  - put: smb-volume-version
    params:
      bump: minor
- name: manual-bump-smb-major
  serial_groups:
  - smb-version
  plan:
  - get: smb-volume-version
    resource: smb-volume-version
    params:
      bump: final
  - put: smb-volume-version
    params:
      bump: major

#### END SMB related jobs ###########################################################################################

#### START cf-deployment related jobs ################################################################################

- name: bbl-destroy
  serial_groups:
  - gorgophone
  - local
  - nfs-test-server
  - nfs
  - efs
  - ecs-deploy
  - csi-local
  - csi-nfs
  - smb
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: gorgophone-env-director-state
  - task: destroy
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_AWS_ACCESS_KEY_ID: {{gorgophone_aws_access_key_id}}
      BBL_AWS_SECRET_ACCESS_KEY: {{gorgophone_aws_secret_access_key}}
    input_mapping:
      bbl-state: gorgophone-env-director-state

- name: bbl-up-gorgophone
  serial_groups:
  - local
  - nfs-test-server
  - nfs
  - ecs-deploy
  - csi-local
  - csi-nfs
  - smb
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: gorgophone-env-director-state
    - get: cf-deployment
#      passed:
#      - cf-deployment-nightly
      trigger: true
    - get: gorgophone-env-vars-store
    - get: persi-ci

  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{gcp_service_account_key}}
      BBL_GCP_REGION: us-west1
      BBL_LB_CERT: {{gorgophone_lbs_ssl_cert}}
      BBL_LB_KEY: {{gorgophone_lbs_ssl_signing_key}}
      BBL_ENV_NAME: bbl-env-victoria-2018-04-23t19-08z
      LB_DOMAIN: gorgophone.cf-app.com
      BBL_STATE_DIR: bbl-state-gcp
      BBL_CONFIG_DIR: operations/bosh-gcp
    input_mapping:
      bbl-state: gorgophone-env-director-state
      bbl-config: persi-ci
    ensure:
      put: gorgophone-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true
  - task: update-cloud-config
    file: persi-ci/scripts/ci/update_cloud_config.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{gcp_service_account_key}}
      BBL_GCP_REGION: us-west1
      BBL_STATE_DIR: bbl-state-gcp

- name: cf-deployment-nightly
  public: true
  plan:
  - get: nightly
    trigger: true
  - get: cf-deployment
  - get: persi-ci
  - task: noop
    file: persi-ci/scripts/ci/noop.build.yml


- name: deploy-cf
  serial_groups:
  - local
  - nfs-test-server
  - nfs
  - ecs-deploy
  - csi-local
  - csi-nfs
  - smb
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: gorgophone-env-director-state
    - get: cf-deployment
      passed:
      - bbl-up-gorgophone
      trigger: true
    - get: gorgophone-env-vars-store
    - get: persi-ci
    - get: diego-dev-release
      passed: [ create-diego-release ]
      trigger: true
    - get: diego-release
    - get: diego-version
      passed: [ create-diego-release ]
    - get: nfs-volume-release
      passed: [ create-nfs-volume-release ]
    - get: nfs-volume-release-tarball
      passed: [ create-nfs-volume-release ]
      trigger: true
    - get: nfsvolume-version
      passed: [ create-nfs-volume-release ]
    - get: local-volume-release
      passed: [ create-local-volume-release ]
      trigger: true
    - get: local-volume-release-tarball
      passed: [ create-local-volume-release ]
    - get: localvolume-version
      passed: [ create-local-volume-release ]
    - get: csi-local-volume-release
      passed: [ create-csi-local-volume-release ]
      trigger: true
    - get: csi-local-volume-release-tarball
      passed: [ create-csi-local-volume-release ]
    - get: csi-local-volume-version
      passed: [ create-csi-local-volume-release ]
    - get: csi-plugins-release
      passed: [ create-csi-plugins-release ]
      trigger: true
    - get: csi-plugins-release-tarball
      passed: [ create-csi-plugins-release ]
    - get: csi-plugins-version
      passed: [ create-csi-plugins-release ]
    - get: mapfs-release
      passed: [ create-mapfs-release ]
      trigger: true
    - get: mapfs-release-tarball
      passed: [ create-mapfs-release ]
    - get: mapfs-version
      passed: [ create-mapfs-release ]
    - get: ecs-release-tarball
      passed: [ create-ecs-release ]
    - get: ecs-version
      passed: [ create-ecs-release ]
    - get: ecs-release
      passed: [ create-ecs-release ]
    - get: smb-volume-release
      passed: [ create-smb-volume-release ]
    - get: smb-volume-release-tarball
      passed: [ create-smb-volume-release ]
      trigger: true
    - get: smb-volume-version
      passed: [ create-smb-volume-release ]
  - task: collect-tarballs
    file: persi-ci/scripts/ci/collect-tarballs.build.yml
    params:
      COLLECT_EFS_TARBALL: false
    input_mapping:
      persi-ci: persi-ci
      diego-tarball: diego-dev-release
      nfs-tarball: nfs-volume-release-tarball
      efs-tarball: nfsvolume-version #dummy
      csi-local-tarball: csi-local-volume-release-tarball
      csi-plugins-tarball: csi-plugins-release-tarball
      mapfs-tarball: mapfs-release-tarball
      ecs-tarball: ecs-release-tarball
      local-tarball: local-volume-release-tarball
      smb-tarball: smb-volume-release-tarball
      diego-version: diego-version
      nfs-version: nfsvolume-version
      efs-version: nfsvolume-version #dummy
      csi-local-version: csi-local-volume-version
      csi-plugins-version: csi-plugins-version
      mapfs-version: mapfs-version
      ecs-version: ecs-version
      local-version: localvolume-version
      smb-version: smb-volume-version
  - task: collect-persi-ci-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: cf-deployment
      new-ops-files: persi-ci
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/scale-up-routers-and-cells.yml
                      operations/add-diego-cell-tagged.yml
                      operations/enable-csi-local-plugin.yml
                      operations/add-static-ip-to-nfstestserver.yml"
  - task: collect-nfs-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: nfs-volume-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/enable-nfs-test-server.yml
                      operations/enable-nfs-test-ldapserver-tls.yml
                      operations/enable-nfs-volume-service-experiment.yml
                      operations/test-nfsbroker-migration-to-credhub.yml
                      operations/set-nfs-ldap-test-mode.yml
                      operations/use-bosh-dns-for-nfs.yml
                      operations/use-pxc-for-nfs-broker.yml
                      operations/enable-nfs-volume-service-credhub.yml"
  - task: collect-local-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: local-volume-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/enable-local-volume-service.yml
                      operations/enable-local-volume-service-windows-cells.yml"
  - task: collect-ecs-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: ecs-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/deploy-ecs-broker-errand.yml"
  - task: collect-smb-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: smb-volume-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/enable-smb-test-server.yml
                      operations/enable-smb-volume-service.yml
                      operations/enable-smb-volume-service-windows.yml
                      operations/use-bosh-dns-for-smb.yml"
  - task: collect-csi-plugins-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: csi-plugins-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/add-csi-nfs-plugin.yml"
  - task: collect-tarball-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: collected-tarballs
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/update-releases.yml"
  - task: parse-diego-cell-ldap
    file: persi-ci/scripts/ci/parse-diego-cell-tagged.build.yml
    input_mapping:
      base-ops-files: collected-ops-files
  - task: add-tarballs
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: collected-tarballs
    params:
      BASE_OPS_FILE_DIR: "."
      NEW_OPS_FILES: "diego.tgz
                      nfs.tgz
                      local.tgz
                      csi-local.tgz
                      csi-plugins.tgz
                      mapfs.tgz
                      ecs.tgz
                      smb.tgz"
  - task: generate-variables
    file: persi-ci/scripts/ci/generate_variables.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp
      BBL_IAAS: gcp
      GENERATE_EFS_VARS: false
      LDAP_HOST: "nfstestldapserver.service.cf.internal"
      LDAP_SVC_USER: {{ldap-svc-user}}
      LDAP_SVC_PASS: {{ldap-svc-pass}}
      LDAP_PORT: 636
      LDAP_PROTO: tcp
      LDAP_USER_FQDN: {{ldap-user-fqdn}}
      ECS_PASSWORD: {{ecs-password}}
      ECS_USERNAME: {{ecs-user}}
      ECS_IP: 35.233.221.61
      ECS_AWS_ID: {{ecs-blob-user}}
      ECS_AWS_KEY: {{ecs-blob-key}}
      S3_BLOBSTORE_ID: {{s3-blobstore-user}}
      S3_BLOBSTORE_KEY: {{s3-blobstore-key}}
      S3_BLOBSTORE_REGION: {{s3-blobstore-region}}
      APP_PACKAGE_DIRECTORY_KEY: persi-cc-packages
      BUILDPACK_DIRECTORY_KEY: persi-cc-buildpacks
      DROPLET_DIRECTORY_KEY: persi-cc-droplets
      RESOURCE_DIRECTORY_KEY: persi-cc-resources
      NFSTESTSERVER_STATIC_IP: 10.0.255.1
      NFSTESTLDAPSERVER_STATIC_IP: 10.0.255.2
      AWS_ACCESS_KEY_ID: {{efs-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{efs-secret-access-key}}
      AWS_SECURITY_GROUP: sg-2ff60150,sg-2ff60150
      AWS_SUBNET_ID: subnet-2bb4b763,subnet-5fa64526
      AWS_AZ: us-west-2a,us-west-2b
      DATADOG_API_KEY: {{gorgophone-datadog-api-key}}
      DATADOG_METRIC_PREFIX: gorgophone
      SMB_USERNAME: {{smb_server_username}}
      SMB_PASSWORD: {{smb_server_password}}
  - task: bosh-upload-xenial-stemcell
    file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
      ops-files: collected-ops-files
    params:
      BBL_STATE_DIR: bbl-state-gcp
  - task: bosh-upload-windows-stemcell
    file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
      ops-files: collected-ops-files
    params:
      BBL_STATE_DIR: bbl-state-gcp
      OPS_FILES: operations/windows2016-cell.yml
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-store: gorgophone-env-vars-store
      bbl-state: gorgophone-env-director-state
      ops-files: collected-ops-files
      vars-files: generated-vars
    params:
      BBL_STATE_DIR: bbl-state-gcp
      MANIFEST_FILE: cf-deployment.yml
      SYSTEM_DOMAIN: gorgophone.cf-app.com # not used, this is a required by the task
      VARS_STORE_FILE: deployment-vars.yml
      VARS_FILES: "nfs-vars.yml cf-vars.yml datadog-vars.yml smb-vars.yml"
      OPS_FILES: "operations/use-compiled-releases.yml
                  operations/scale-to-one-az.yml
                  operations/scale-up-routers-and-cells.yml
                  operations/use-bosh-dns-for-nfs.yml
                  operations/use-bosh-dns-for-smb.yml
                  operations/windows2016-cell.yml
                  operations/experimental/use-compiled-releases-windows.yml
                  operations/enable-nfs-volume-service.yml
                  operations/enable-nfs-volume-service-credhub.yml
                  operations/experimental/migrate-nfsbroker-mysql-to-credhub.yml
                  operations/enable-local-volume-service.yml
                  operations/enable-local-volume-service-windows-cells.yml
                  operations/enable-nfs-test-server.yml
                  operations/enable-nfs-ldap.yml
                  operations/enable-nfs-test-ldapserver-tls.yml
                  operations/parsed-diego-cell-tagged.yml
                  operations/enable-smb-test-server.yml
                  operations/enable-csi-local-plugin.yml
                  operations/add-static-ip-to-nfstestserver.yml
                  operations/add-csi-nfs-plugin.yml
                  operations/deploy-ecs-broker-errand.yml
                  operations/set-nfs-ldap-test-mode.yml
                  operations/backup-and-restore/enable-backup-restore.yml
                  operations/backup-and-restore/enable-backup-restore-nfs-broker.yml
                  operations/backup-and-restore/enable-backup-restore-smb-broker.yml
                  operations/enable-smb-volume-service.yml
                  operations/enable-smb-volume-service-windows.yml
                  operations/update-releases.yml
                  operations/experimental/use-pxc.yml
                  operations/use-pxc-for-nfs-broker.yml
                  operations/test-nfsbroker-migration-to-credhub.yml
                  operations/experimental/add-cflinuxfs3.yml"
  - task: bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-gcp

- name: bbl-up-boshlite-aws
  serial_groups:
  - efs
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: deployments-persi
    - get: bosh-bootloader
    - get: cf-deployment-concourse-tasks
    - get: gorgophone-env-director-state
    - get: cf-deployment
      passed:
      - bbl-up-gorgophone
      trigger: true
    - get: persi-ci
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_STATE_DIR: bbl-state-boshlite-aws
      BBL_IAAS: aws
      BBL_AWS_ACCESS_KEY_ID: {{gorgophone_aws_access_key_id}}
      BBL_AWS_SECRET_ACCESS_KEY: {{gorgophone_aws_secret_access_key}}
      BBL_AWS_REGION: us-west-2
      SKIP_LB_CREATION: true
      BBL_CONFIG_DIR: plan-patches/bosh-lite-aws
    input_mapping:
      bbl-state: gorgophone-env-director-state
      bbl-config: bosh-bootloader
    ensure:
      put: gorgophone-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: deploy-cf-efs
  serial_groups:
  - efs
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: deployments-persi
    - get: cf-deployment-concourse-tasks
    - get: gorgophone-env-director-state
    - get: cf-deployment
      passed:
      - bbl-up-boshlite-aws
      trigger: true
    - get: bosh-bootloader
    - get: persi-ci
    - get: diego-dev-release
      passed: [ create-diego-release ]
      trigger: true
    - get: diego-release
    - get: diego-version
      passed: [ create-diego-release ]
    - get: efs-volume-release
      passed: [ create-efs-volume-release ]
      trigger: true
    - get: efs-volume-release-tarball
      passed: [ create-efs-volume-release ]
    - get: efsvolume-version
      passed: [ create-efs-volume-release ]
    - get: mapfs-release
      passed: [ create-mapfs-release ]
    - get: mapfs-release-tarball
      passed: [ create-mapfs-release ]
    - get: mapfs-version
      passed: [ create-mapfs-release ]
  - task: collect-tarballs
    file: persi-ci/scripts/ci/collect-tarballs.build.yml
    params:
      COLLECT_DIEGO_TARBALL: true
      COLLECT_NFS_TARBALL: false
      COLLECT_EFS_TARBALL: true
      COLLECT_CSI_LOCAL_TARBALL: false
      COLLECT_CSI_PLUGINS_TARBALL: false
      COLLECT_ECS_TARBALL: false
      COLLECT_LOCAL_TARBALL: false
      COLLECT_SMB_TARBALL: false
      COLLECT_MAPFS_TARBALL: false
    #this task requires a lot of inputs that we don't need for this instance--we're feeding in
    #efsvolume-version as a dummy input because it is tiny and easy to copy
    input_mapping:
      persi-ci: persi-ci
      diego-tarball: diego-dev-release
      nfs-tarball: efsvolume-version #dummy
      efs-tarball: efs-volume-release-tarball
      csi-local-tarball: efsvolume-version #dummy
      csi-plugins-tarball: efsvolume-version #dummy
      mapfs-tarball: mapfs-release-tarball #dummy
      ecs-tarball: efsvolume-version #dummy
      local-tarball: efsvolume-version #dummy
      smb-tarball: efsvolume-version #dummy
      diego-version: diego-version
      nfs-version: efsvolume-version #dummy
      efs-version: efsvolume-version
      csi-local-version: efsvolume-version #dummy
      csi-plugins-version: efsvolume-version #dummy
      mapfs-version: mapfs-version #dummy
      ecs-version: efsvolume-version #dummy
      local-version: efsvolume-version #dummy
      smb-version: efsvolume-version #dummy
  - task: collect-efs-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: cf-deployment
      new-ops-files: efs-volume-release
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/deploy-efs-broker-and-install-driver.yml"
  - task: collect-tarball-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: collected-tarballs
    params:
      BASE_OPS_FILE_DIR: "operations"
      NEW_OPS_FILES: "operations/update-releases.yml"
  - task: add-tarballs
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: collected-tarballs
    params:
      BASE_OPS_FILE_DIR: "."
      NEW_OPS_FILES: "diego.tgz efs.tgz"
  - task: generate-variables
    file: persi-ci/scripts/ci/generate_variables.build.yml
    input_mapping:
      director-state: gorgophone-env-director-state
    params:
      GENERATE_NFS_VARS: false
      GENERATE_EFS_VARS: true
      GENERATE_SMB_VARS: false
      GENERATE_ECS_BLOBSTORE_VARS: false
      GENERATE_DATADOG_VARS: false
      AWS_ACCESS_KEY_ID: {{efs-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{efs-secret-access-key}}
      AWS_SECURITY_GROUP: sg-854aa7f6
      AWS_SUBNET_ID: subnet-08e7b271
      AWS_AZ: us-west-2b
  - task: bosh-upload-stemcell
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-boshlite-aws
      INFRASTRUCTURE: bosh-lite
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
      ops-files: collected-ops-files
      vars-files: generated-vars
    params:
      BBL_STATE_DIR: bbl-state-boshlite-aws
      MANIFEST_FILE: cf-deployment.yml
      SYSTEM_DOMAIN: 34.213.225.99.sslip.io
      VARS_STORE_FILE: deployment-vars-bosh-lite.yml
      VARS_FILES: "efs-vars.yml"
      OPS_FILES: "operations/aws.yml
                  operations/bosh-lite.yml
                  operations/deploy-efs-broker-and-install-driver.yml
                  operations/update-releases.yml"
  - task: bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
    params:
      BBL_STATE_DIR: bbl-state-boshlite-aws

- name: pats-drats
  serial: true
  serial_groups:
  - gorgophone
  - local
  - nfs-test-server
  - nfs
  - ecs-deploy
  - csi-local
  - csi-nfs
  - smb
  plan:
  - aggregate:
    - get: diego-dev-release
      passed:
      - deploy-cf
      trigger: true
    - get: nfs-volume-release
      passed:
      - deploy-nfs-brokers
      trigger: true
    - get: smb-volume-release
      passed:
      - deploy-smb-broker
      trigger: true
    - get: bbr-binary-release
    - get: disaster-recovery-acceptance-tests
    - get: gorgophone-env-director-state
    - get: persi-ci
  - task: update-integration-config
    file: disaster-recovery-acceptance-tests/ci/credhub-compatible/update-integration-config/task.yml
    input_mapping:
      bbl-state: gorgophone-env-director-state
      integration-configs: persi-ci
    params:
      BBL_STATE_DIR: bbl-state-gcp
      INTEGRATION_CONFIG_FILE_PATH: config/drats.json
      SYSTEM_DOMAIN: gorgophone.cf-app.com
  - task: acceptance-tests
    file: disaster-recovery-acceptance-tests/ci/drats-with-integration-config/task.yml
    privileged: true
    input_mapping:
      drats-integration-config: updated-integration-configs
    params:
      CONFIG_FILE_PATH: config/drats.json

#### END cf-deployment related jobs ##################################################################################

###################################### END JOBS SECTION ##############################################################
