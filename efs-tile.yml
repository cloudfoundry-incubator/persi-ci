groups:
- name: efs-tile
  jobs:
  - build-efs-broker-tile
  - build-vpn-client-tile
  - acquire-lock-efstile
  - bbl-up-efstile
  # - bosh-deploy-openvpn
  # - claim-toolsmiths-env
  # - upload-tiles-and-stemcell
  # - configure-efs-broker-tile
  # - configure-vpn-client-tile
  # - apply-changes
  # - pats-efs
  # - unclaim-toolsmiths-env
  # - bosh-delete-openvpn
  - bbl-destroy-efstile

- name: build
  jobs:
  - build-efs-broker-tile
  - build-vpn-client-tile

- name: test
  jobs:
  - acquire-lock-efstile
  - bbl-up-efstile
#   - bosh-deploy-openvpn
#   - claim-toolsmiths-env
#   - upload-tiles-and-stemcell
#   - configure-efs-broker-tile
#   - configure-vpn-client-tile
#   - apply-changes
#   - pats-efs
#   - unclaim-toolsmiths-env
#   - bosh-delete-openvpn
  - bbl-destroy-efstile

resource_types:
- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:
## General ##
- name: bosh-bootloader
  type: git
  source:
    branch: master
    uri: https://github.com/paulcwarren/bosh-bootloader.git

- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

- name: env-creation-gate-lock
  type: pool
  source:
    uri: git@github.com:cloudfoundry/gorgophone-env.git
    branch: master
    pool: gate-locks
    private_key: {{deployments-persi-key}}

- name: gorgophone-env-director-state
  type: git
  source:
    uri: git@github.com:cloudfoundry/gorgophone-env.git
    branch: master
    private_key: {{deployments-persi-key}}

- name: kiln-concourse-tasks
  type: git
  source:
    branch: master
    uri: git@github.com:davewalter/kiln-concourse-tasks.git
    private_key: {{deployments-persi-key}}
## End General ##

## Releases ##
- name: bpm-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/bpm-release

- name: efs-volume-release-tarball
  type: s3
  source:
    bucket: efs-volume-release-tarballs
    regexp: efs-volume-(.*).tgz
    access_key_id: {{efsvolume-reader_aws_ID}}
    secret_access_key: {{efsvolume-reader_aws_secret}}

- name: openvpn-release-tarball
  type: bosh-io-release
  source:
    repository: dpb587/openvpn-bosh-release

- name: routing-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release
## End Releases ##

## Stemcell ##
- name: stemcell-linux-xenial
  type: pivnet
  source:
    api_token: ((persi_pivnet_refresh_token))
    product_slug: stemcells-ubuntu-xenial
    product_version: ^250\.\d+
    sort_by: semver
## End Stemcell ##

## EFS Broker Tile ##
- name: efs-broker-tile-bucket
  type: s3
  source:
    access_key_id: ((tile_manager_aws_access_key_id))
    secret_access_key: ((tile_manager_aws_secret_access_key))
    bucket: efs-broker-tiles
    private: true
    region_name: us-west-2
    regexp: efs-broker-(.*).pivotal

- name: efs-broker-tile-metadata-repo
  type: git
  source:
    uri: git@github.com:davewalter/aws-efs-broker-tile.git
    branch: master
    private_key: {{deployments-persi-key}}
    ignore_paths:
    - version

- name: efs-broker-tile-version
  type: semver
  source:
    driver: git
    uri: git@github.com:davewalter/aws-efs-broker-tile.git
    branch: master
    file: version
    initial_version: 0.0.1-build.1
    private_key: {{deployments-persi-key}}
## End EFS Broker Tile ##

## VPN Client Tile ##
- name: vpn-client-tile-bucket
  type: s3
  source:
    access_key_id: ((tile_manager_aws_access_key_id))
    secret_access_key: ((tile_manager_aws_secret_access_key))
    bucket: vpn-client-tiles
    private: true
    region_name: us-west-2
    regexp: vpn-client-(.*).pivotal

- name: vpn-client-tile-metadata-repo
  type: git
  source:
    uri: git@github.com:davewalter/aws-efs-broker-vpn-client-tile.git
    branch: master
    private_key: {{deployments-persi-key}}
    ignore_paths:
    - version

- name: vpn-client-tile-version
  type: semver
  source:
    driver: git
    uri: git@github.com:davewalter/aws-efs-broker-vpn-client-tile.git
    branch: master
    file: version
    initial_version: 0.0.1-build.1
    private_key: {{deployments-persi-key}}
## End VPN Client Tile ##

jobs:
- name: build-efs-broker-tile
  serial: true
  plan:
  - aggregate:
    - get: bpm-release-tarball
      params:
        tarball: true
      trigger: true
    - get: efs-volume-release-tarball
      trigger: true
    - get: kiln-concourse-tasks
    - get: metadata-repo
      resource: efs-broker-tile-metadata-repo
      trigger: true
    - get: routing-release-tarball
      params:
        tarball: true
      trigger: true
    - get: stemcell
      resource: stemcell-linux-xenial
      params:
        globs:
        - '*google*'
      trigger: true
    - get: version
      resource: efs-broker-tile-version
  - task: collect-bpm-release
    file: kiln-concourse-tasks/collect-release/task.yml
    input_mapping:
      base-releases: efs-volume-release-tarball
      new-release: bpm-release-tarball
    params:
      RELEASE_NAME: bpm
  - task: collect-routing-release
    file: kiln-concourse-tasks/collect-release/task.yml
    input_mapping:
      base-releases: collected-releases
      new-release: routing-release-tarball
    params:
      RELEASE_NAME: routing
  - task: create-tile
    file: kiln-concourse-tasks/bake/task.yml
    input_mapping:
      releases: collected-releases
    params:
      TILE_FILENAME_PREFIX: efs-broker
  - put: efs-broker-tile-version
    params:
      pre: build
  - put: efs-broker-tile-bucket
    params:
      file: tile/*.pivotal
    get_params:
      skip_download: 'true'

- name: build-vpn-client-tile
  serial: true
  plan:
  - aggregate:
    - get: kiln-concourse-tasks
    - get: metadata-repo
      resource: vpn-client-tile-metadata-repo
      trigger: true
    - get: openvpn-release-tarball
      params:
        tarball: true
      trigger: true
    - get: stemcell
      resource: stemcell-linux-xenial
      params:
        globs:
        - '*google*'
      trigger: true
    - get: version
      resource: vpn-client-tile-version
  - task: create-tile
    file: kiln-concourse-tasks/bake/task.yml
    input_mapping:
      releases: openvpn-release-tarball
    params:
      ICON_FILENAME: icon.jpg
      TILE_FILENAME_PREFIX: vpn-client
  - put: vpn-client-tile-version
    params:
      pre: build
  - put: vpn-client-tile-bucket
    params:
      file: tile/*.pivotal
    get_params:
      skip_download: 'true'

- name: acquire-lock-efstile
  serial: true
  plan:
  - aggregate:
    - get: efs-broker-tile-bucket
      passed:
      - build-efs-broker-tile
      trigger: true
    - get: vpn-client-tile-bucket
      passed:
      - build-vpn-client-tile
      trigger: true
  - put: env-creation-gate-lock
    params:
      claim: efstile
    timeout: 3h

- name: bbl-up-efstile
  plan:
  - aggregate:
    - get: bosh-bootloader
    - get: cf-deployment-concourse-tasks
    - get: env-creation-gate-lock
      passed:
      - acquire-lock-efstile
      trigger: true
    - get: gorgophone-env-director-state
    - get: efs-broker-tile-bucket
      passed:
      - acquire-lock-efstile
    - get: vpn-client-tile-bucket
      passed:
      - acquire-lock-efstile
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: aws
      BBL_AWS_ACCESS_KEY_ID: {{gorgophone_aws_access_key_id}}
      BBL_AWS_SECRET_ACCESS_KEY: {{gorgophone_aws_secret_access_key}}
      BBL_AWS_REGION: us-west-2
      BBL_CONFIG_DIR: plan-patches/openvpn-aws
      BBL_STATE_DIR: bbl-state-aws-efstile
      BBL_ENV_NAME: efstile
      GIT_COMMIT_EMAIL: cf-diego-persistence@pivotal.io
      SKIP_LB_CREATION: true
    input_mapping:
      bbl-state: gorgophone-env-director-state
      bbl-config: bosh-bootloader
    ensure:
      put: gorgophone-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: bbl-destroy-efstile
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: env-creation-gate-lock
      passed:
      - bbl-up-efstile
    - get: gorgophone-env-director-state
      passed:
      - bbl-up-efstile
      trigger: true
  - task: destroy
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: bbl-state-aws-efstile
      GIT_COMMIT_EMAIL: cf-diego-persistence@pivotal.io
      BBL_AWS_ACCESS_KEY_ID: {{gorgophone_aws_access_key_id}}
      BBL_AWS_SECRET_ACCESS_KEY: {{gorgophone_aws_secret_access_key}}
    input_mapping:
      bbl-state: gorgophone-env-director-state
    ensure:
      put: gorgophone-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true
  - put: env-creation-gate-lock
    params:
      release: env-creation-gate-lock
