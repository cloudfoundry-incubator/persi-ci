groups:
- name: diego
  jobs:
  - check-for-rep-drift
  - units-common
  - units-mysql
  - units-postgres
  - validate-garden-version
  - inigo-mysql
  - inigo-postgres
  - candidate
  - create-diego-release
  - create-cf-release
  - electron-cannon-deploy-cf-deployment
  - electron-cannon-cf-acceptance-tests
  - ketchup-diego-deploy
  - ketchup-diego-windows-deploy
  - ketchup-diego-funky-cells-deploy
  - ketchup-cf-deploy
  - ketchup-mysql-deploy
  - ketchup-smoke-tests
  - dusts-etcd2sql
  - dusts
  - ketchup-cf-acceptance-tests
  - ketchup-run-wats
  - ketchup-vizzini
  - time-rotor-deploy
  - time-rotor-benchmark-bbs-tests
  - time-rotor-bosh-cleanup
  - deliver
  - shipit
  - github-release
  - merge-master-into-develop
- name: dusts
  jobs:
  - dusts-etcd2sql
  - dusts
  - dusts-etcd2sql-provision-periodic
  - dusts-provision-periodic
- name: electron-cannon
  jobs:
  - electron-cannon-deploy-cf-deployment
  - electron-cannon-cf-acceptance-tests
- name: version
  jobs:
  - major-bump
  - minor-bump
  - patch-bump
- name: diego-periodic
  jobs:
  - ketchup-vizzini-periodic
  - ketchup-bosh-cleanup
  - dusts-etcd2sql-provision-periodic
  - dusts-provision-periodic
- name: benchmarks
  jobs:
  - time-rotor-deploy
  - time-rotor-benchmark-bbs-tests
  - time-rotor-bosh-cleanup
- name: manual
  jobs:
  - ketchup-push-canary
  - release-candidate-lock

jobs:
- name: check-for-rep-drift
  public: true
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/check_for_rep_drift.yml

- name: units-common
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    params:
      SCRIPT: run-unit-tests-no-backing-store

- name: units-mysql
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    params:
      SCRIPT: run-unit-tests-with-backing-store
      SQL_FLAVOR: mysql

- name: units-postgres
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    params:
      SCRIPT: run-unit-tests-with-backing-store
      SQL_FLAVOR: postgres

- name: inigo-mysql
  serial: true
  public: true
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: diego-ci
  - task: garden-runc-release
    file: diego-ci/concourse/checkout_garden.build.yml
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_inigo.build.yml
    tags: ["inigo-mysql"]
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      SKIP_PACKAGES: volman
      SQL_FLAVOR: mysql

- name: inigo-postgres
  serial: true
  public: true
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: diego-ci
  - task: garden-runc-release
    file: diego-ci/concourse/checkout_garden.build.yml
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_inigo.build.yml
    tags: ["inigo-postgres"]
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      SKIP_PACKAGES: volman
      SQL_FLAVOR: postgres

- name: validate-garden-version
  public: true
  plan:
  - aggregate:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: [src/code.cloudfoundry.org/garden]}
    - get: diego-ci
  - task: compare-garden-releases
    file: diego-ci/concourse/compare_garden_releases.build.yml

- name: ketchup-vizzini
  serial_groups: [ketchup-vizzini]
  plan:
  - get: candidate-lock
    passed: [ketchup-smoke-tests]
    trigger: true
  - aggregate:
    - get: diego-ci
    - get: diego-release-tarball
      passed: [ketchup-diego-deploy]
      resource: diego-dev-release
    - get: diego-release
      passed: [ketchup-diego-deploy]
      params: {submodules: none}
    - get: deployments-diego
      resource: ketchup-config
    - get: bosh-stemcell
      resource: aws-stemcell
  - task: generate-manifest
    file: diego-ci/concourse/generate_vizzini_manifest.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin
      DEPLOYMENTS_DIR: deployments-diego
      ENVIRONMENT_NAME: ketchup
  - put: ketchup-vizzini-deployment
    params:
      manifest: generated-manifest/vizzini.yml
      releases: [diego-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: run
    file: diego-ci/concourse/run_errand.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin
      MANIFEST: generated-manifest/vizzini.yml
      ERRAND: vizzini

- name: ketchup-vizzini-periodic
  serial_groups: [ketchup-vizzini]
  plan:
  - aggregate:
    - get: diego-ci
    - get: 30min
      trigger: true
    - get: diego-release-tarball
      passed: [ketchup-diego-deploy]
      resource: diego-dev-release
    - get: diego-release
      passed: [ketchup-diego-deploy]
      params: {submodules: none}
    - get: deployments-diego
      resource: ketchup-config
    - get: bosh-stemcell
      resource: aws-stemcell
  - task: generate-manifest
    file: diego-ci/concourse/generate_vizzini_manifest.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin
      DEPLOYMENTS_DIR: deployments-diego
      ENVIRONMENT_NAME: ketchup
  - put: ketchup-vizzini-deployment
    params:
      manifest: generated-manifest/vizzini.yml
      releases: [diego-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: run
    file: diego-ci/concourse/run_errand.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin
      MANIFEST: generated-manifest/vizzini.yml
      ERRAND: vizzini

- name: ketchup-bosh-cleanup
  serial: true
  plan:
  - aggregate:
    - get: diego-ci
    - get: daily
      trigger: true
  - task: cleanup
    file: diego-ci/concourse/bosh_cleanup.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin

- name: time-rotor-bosh-cleanup
  serial: true
  plan:
  - aggregate:
    - get: diego-ci
    - get: daily
      trigger: true
  - task: cleanup
    file: diego-ci/concourse/bosh_cleanup.build.yml
    params:
      BOSH_PASSWORD: {{time-rotor-director-password}}
      BOSH_TARGET: bosh.time-rotor.cf-app.com
      BOSH_USER: admin

- name: create-cf-release
  plan:
  - aggregate:
    - get: cf-release
      trigger: true
    - get: diego-ci
  - task: create-release
    file: diego-ci/concourse/create_cf_dev_release.build.yml
  - put: cf-dev-release
    params:
      file: created-cf-release/cf-dev-release-*.tgz

- name: patch-bump
  serial_groups: [version]
  plan:
  - get: version
    passed: [shipit]
    params: {bump: patch}
    trigger: true
  - put: version
    params: {file: version/number}

- name: minor-bump
  serial_groups: [version]
  plan:
  - get: version
    params: {bump: minor}
  - put: version
    params: {file: version/number}

- name: major-bump
  serial_groups: [version]
  plan:
  - get: version
    params: {bump: major}
  - put: version
    params: {file: version/number}

- name: create-diego-release
  serial_groups: [version]
  plan:
  - aggregate:
    - get: diego-ci
    - get: diego-release
      passed: [check-for-rep-drift, units-common, units-mysql, units-postgres, inigo-mysql, inigo-postgres]
      trigger: true
    - get: version
      params: {pre: rc}
  - put: version
    params: {file: version/number}
  - task: create-release
    file: diego-ci/concourse/create_diego_dev_release.build.yml
  - put: diego-dev-release
    params:
      file: created-diego-release/diego-*.tgz

- name: candidate
  serial: true
  public: true
  plan:
  - put: candidate-lock
    params: {acquire: true}
  - aggregate:
    - get: diego-release
      passed: [create-diego-release]
      params: {submodules: none}
      trigger: true
    - get: diego-release-tarball
      resource: diego-dev-release
      passed: [create-diego-release]
      trigger: true
    - get: cf-release
      passed: [create-cf-release]
      params: {submodules: none}
      trigger: true
    - get: cf-release-tarball
      resource: cf-dev-release
      passed: [create-cf-release]
      trigger: true
    - get: cf-mysql-release
      params: {submodules: none}
      trigger: true
    - get: cf-mysql-release-tarball
      trigger: true
    - get: garden-runc-release-tarball
      passed: [inigo-mysql, inigo-postgres]
      trigger: true
    - get: etcd-release-tarball
      trigger: true
    - get: cflinuxfs2-rootfs-release-tarball
      trigger: true
    - get: garden-windows-release-tarball
      trigger: true
    - get: ketchup-config
    - get: aws-stemcell
    - get: aws-windows-stemcell
    - get: diego-ci

- name: release-candidate-lock
  plan:
  - get: candidate-lock
  - put: candidate-lock
    params: {release: candidate-lock}

- name: electron-cannon-deploy-cf-deployment
  serial_groups: [electron-cannon-group]
  plan:
  - aggregate:
    - get: bosh-stemcell
      resource: aws-stemcell
      trigger: true
    - get: deployments-diego
      resource: electron-cannon-config
      trigger: true
    - get: diego-release
      passed: [candidate]
      trigger: true
    - get: diego-ci
    - get: cf-deployment
      trigger: true
  - task: deploy-cf-deployment
    file: diego-ci/concourse/deploy_cf_deployment.build.yml
    params:
      BOSH_ENVIRONMENT: 34.192.111.51
      BOSH_USER: user-4awf0f4
      BOSH_PASSWORD: p-mXBN4JLQKs5fE0z
      BOSH_DEPLOYMENT: cf
      DEPLOYMENT_DIR: electron-cannon
  - task: enable-docker
    file: diego-ci/concourse/enable_diego_docker_feature_flag.build.yml
    params:
      CF_TARGET: api.electron-cannon.cf-app.com
      CF_USER: admin
      CF_PASSWORD: {{electron-cannon-cf-admin-password}}

- name: electron-cannon-cf-acceptance-tests
  serial_groups: [electron-cannon-group]
  plan:
  - aggregate:
    - get: cf-release
      passed: [candidate]
      params:
        submodules: ['src/github.com/cloudfoundry/cf-acceptance-tests']
    - get: diego-release
      params: {submodules: none}
      passed: [electron-cannon-deploy-cf-deployment]
      trigger: true
    - get: runtime-ci
    - get: electron-cannon-cats-config
  - task: cats-from-cf-release
    file: runtime-ci/scripts/ci/cats-from-cf-release/task.yml
  - task: run-cats
    file: runtime-ci/scripts/ci/run-cats/task.yml
    input_mapping:
    - integration-config: electron-cannon-cats-config
    params:
    - CONFIG_FILE_PATH: electron-cannon/integration_config.json

- name: ketchup-diego-deploy
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: diego-dev-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: cf-dev-release
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [candidate]
    - get: deployments-diego
      resource: ketchup-config
    - get: diego-ci
  - task: generate-deployment-manifests
    file: diego-ci/concourse/generate_deployment_manifests.build.yml
    params:
      ENVIRONMENT_NAME: ketchup
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-diego-datadog-started
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup-diego
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: diego
  - put: ketchup-diego-deployment
    params:
      manifest: generated-manifest/diego-deployment.yml
      releases: [cf-dev-release/*.tgz, diego-dev-release/*.tgz, garden-runc-release-tarball/*.tgz, cflinuxfs2-rootfs-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup-diego
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: diego

- name: ketchup-cf-deploy
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: cf-dev-release
      passed: [candidate]
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [candidate]
    - get: deployments-diego
      resource: ketchup-config
    - get: diego-ci
  - task: generate-deployment-manifests
    file: diego-ci/concourse/generate_deployment_manifests.build.yml
    params:
      ENVIRONMENT_NAME: ketchup
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-cf-datadog-start
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: cf
  - put: ketchup-cf-deployment
    params:
      manifest: generated-manifest/cf-deployment.yml
      releases: [cf-dev-release/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: cf
  - task: enable-docker
    file: diego-ci/concourse/enable_diego_docker_feature_flag.build.yml
    params:
      CF_TARGET: api.ketchup.cf-app.com
      CF_USER: admin
      CF_PASSWORD: {{ketchup-cf-admin-password}}

- name: ketchup-diego-funky-cells-deploy
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: diego-dev-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: garden-windows-release-tarball
      passed: [candidate]
    - get: bosh-windows-stemcell
      resource: aws-windows-stemcell
      passed: [candidate]
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [candidate]
    - get: deployments-diego
      resource: ketchup-config
    - get: diego-ci
  - task: generate-funky-cell-deployment-manifest
    file: diego-ci/concourse/generate_funky_cell_deployment_manifest.build.yml
    params:
      ENVIRONMENT_NAME: ketchup
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - put: ketchup-diego-funky-cells-deployment
    params:
      manifest: generated-manifest/diego-funky-cells-deployment.yml
      releases: [diego-dev-release/*.tgz, garden-windows-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]

- name: ketchup-diego-windows-deploy
  serial_groups: [ketchup-diego-windows-deploy]
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: diego-dev-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: garden-windows-release-tarball
      passed: [candidate]
    - get: bosh-stemcell
      resource: aws-windows-stemcell
      passed: [candidate]
    - get: deployments-diego
      resource: ketchup-config
    - get: diego-ci
  - task: generate-windows-cell-deployment-manifest
    file: diego-ci/concourse/generate_windows_cell_deployment_manifest.build.yml
    params:
      ENVIRONMENT_NAME: ketchup
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-diego-datadog-started
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup-diego-windows
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: diego-windows
  - put: ketchup-diego-windows-deployment
    params:
      manifest: generated-manifest/diego-windows-deployment.yml
      releases: [diego-dev-release/*.tgz, garden-windows-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: cf-ketchup-diego-windows
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: diego-windows

- name: ketchup-mysql-deploy
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: cf-mysql-release
      passed: [candidate]
      params: {submodules: none}
    - get: cf-release
      passed: [candidate]
      params: {submodules: none}
    - get: cf-mysql-release-tarball
      passed: [candidate]
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [candidate]
    - get: deployments-diego
      resource: ketchup-config
    - get: diego-ci
  - task: generate-mysql-deployment-manifest
    file: diego-ci/concourse/generate_mysql_deployment_manifest.build.yml
    params:
      ENVIRONMENT_NAME: ketchup
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-mysql-datadog-start
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: ketchup
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: mysql
  - put: ketchup-mysql-deployment
    params:
      manifest: generated-manifest/mysql-deployment.yml
      releases: [cf-mysql-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-mysql-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: ketchup
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: mysql

- name: ketchup-smoke-tests
  plan:
  - get: candidate-lock
    passed: [ketchup-diego-deploy, ketchup-cf-deploy, ketchup-mysql-deploy]
    trigger: true
  - aggregate:
    - get: diego-ci
  - task: diego-smoke-tests
    file: diego-ci/concourse/run_smoke_tests.build.yml
    params:
      BOSH_PASSWORD: {{ketchup-director-password}}
      BOSH_TARGET: bosh.ketchup.cf-app.com
      BOSH_USER: admin
      DEPLOYMENT_NAME: cf-ketchup
    ensure:
      put: diego-trace-ketchup-smoke-logs
      params:
        file: smoke-test-results/smoke_tests*.tgz

- name: ketchup-cf-acceptance-tests
  plan:
  - get: candidate-lock
    passed: [ketchup-smoke-tests]
    trigger: true
  - aggregate:
    - get: ketchup-cats-config
    - get: cf-release
      passed: [ketchup-cf-deploy]
      params:
        submodules: ['src/github.com/cloudfoundry/cf-acceptance-tests']
    - get: diego-release
      passed: [ketchup-diego-deploy]
      params: {submodules: none}
    - get: runtime-ci
  - task: cats-from-cf-release
    file: runtime-ci/scripts/ci/cats-from-cf-release/task.yml
  - task: run-cats
    file: runtime-ci/scripts/ci/run-cats/task.yml
    input_mapping:
    - integration-config: ketchup-cats-config
    params:
    - CONFIG_FILE_PATH: ketchup/integration_config.json

- name: deliver
  plan:
  - get: candidate-lock
    passed:
    - candidate
    - dusts
    - dusts-etcd2sql
    - ketchup-cf-acceptance-tests
    - ketchup-vizzini
    - ketchup-run-wats
    - ketchup-diego-funky-cells-deploy
    trigger: true
  - aggregate:
    - get: cf-release
      passed: [candidate]
      params: {submodules: none}
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: cf-mysql-release
      passed: [candidate]
      params: {submodules: none}
    - get: diego-dev-release
      passed: [candidate]
    - get: cf-dev-release
      passed: [candidate]
    - get: ketchup-config
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: garden-windows-release-tarball
      passed: [candidate]
    - get: etcd-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: cf-mysql-release-tarball
      passed: [candidate]
  - put: tracker
    params: {repos: [diego-release]}
  - put: diego-release-release-candidate
    params:
      repository: diego-release/
  - put: candidate-lock
    params: {release: candidate-lock}

- name: shipit
  serial_groups: [version]
  plan:
  - aggregate:
    - get: diego-ci
    - get: diego-release
      passed: [deliver]
      params: {submodules: none}
    - get: diego-release-master
      params: {submodules: none}
    - get: runtime-credentials
    - get: diego-dev-release
      passed: [deliver]
    - get: garden-runc-release-tarball
      passed: [deliver]
    - get: garden-windows-release-tarball
      passed: [deliver]
    - get: etcd-release-tarball
      passed: [deliver]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [deliver]
    - get: cf-mysql-release-tarball
      passed: [deliver]
    - get: version
      params: {bump: final}
  - put: version
    params: {file: version/number}
  - task: finalize-release
    file: diego-ci/concourse/finalize_release.build.yml
  - put: diego-final-releases
    params:
      file: finalized-release/diego-*.tgz
  - put: diego-release-master
    params:
      repository: finalized-release/diego-release
      tag: version/number
      tag_prefix: v

- name: github-release
  plan:
  - aggregate:
    - get: diego-ci
    - get: garden-runc-release-tarball
      passed: [shipit]
      trigger: true
    - get: garden-windows-release-tarball
      passed: [shipit]
      trigger: true
    - get: etcd-release-tarball
      passed: [shipit]
      trigger: true
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [shipit]
      trigger: true
    - get: cf-mysql-release-tarball
      passed: [shipit]
      trigger: true
    - get: diego-final-releases
      passed: [shipit]
      trigger: true
    - get: diego-release-master
      passed: [shipit]
      params: {submodules: none}
      trigger: true
  - task: generate-release
    file: diego-ci/concourse/generate_github_release.build.yml
  - put: github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs:
      - generated-release/garden-runc-*.tgz
      - generated-release/garden-windows-*.tgz
      - generated-release/etcd-*.tgz
      - generated-release/cflinuxfs2-rootfs-*.tgz
      - generated-release/cf-mysql-release-*.tgz
      - diego-final-releases/*.tgz

- name: merge-master-into-develop
  plan:
    - aggregate:
      - get: diego-ci
      - get: diego-release-master
        trigger: true
        passed: [shipit]
        params:
          submodules: none
      - get: diego-release
        params:
          submodules: none
    - task: merge-master-into-develop
      file: diego-ci/concourse/merge-master-into-develop.build.yml
    - put: diego-release-mergeback
      params:
        repository: merged-master/diego-release

- name: ketchup-push-canary
  serial: true
  plan:
  - aggregate:
    - get: diego-ci
    - get: diegocanaryapp
  - task: run
    file: diego-ci/concourse/push_canary_app.build.yml
    params:
      API: api.ketchup.cf-app.com
      ORG: canaries
      PASSWORD: {{ketchup-cf-admin-password}}
      SPACE: coal-mine
      USER: admin
      APP_DOMAIN: ketchup.cf-app.com
      APP_NAME: diego-canary-app
      DEPLOYMENT_NAME: cf-ketchup-diego
      INSTANCE_COUNT: 20
      DATADOG_API_KEY: {{datadog-api-key}}
      CF_STACK: cflinuxfs2
      PAPERTRAIL_SERVICE_NAME: papertrail
      PAPERTRAIL_DEST: logs2.papertrailapp.com:25005

- name: ketchup-run-wats
  serial_groups: [ketchup-diego-windows-deploy]
  plan:
  - get: candidate-lock
    passed: [ketchup-diego-windows-deploy,ketchup-smoke-tests,ketchup-cf-acceptance-tests]
    trigger: true
  - aggregate:
      - get: greenhouse-ci
      - get: wats
  - task: wats
    file: greenhouse-ci/tasks/run-wats.yml
    params:
      ADMIN_PASSWORD: {{ketchup-cf-admin-password}}
      ADMIN_USER: admin
      API: api.ketchup.cf-app.com
      APPS_DOMAIN: ketchup.cf-app.com
      SOCKET_ADDRESS_FOR_SECURITY_GROUP_TEST: 10.10.0.6:25555
      DOPPLER_URL: wss://doppler.ketchup.cf-app.com:4443
      NUM_WIN_CELLS: 2

- name: time-rotor-deploy
  serial_groups: [time-rotor-benchmark]
  plan:
  - aggregate:
    - get: diego-ci
    - get: runtime-credentials
    - get: diego-release
      passed: [deliver]
      params: {submodules: none}
    - get: deployments-diego
      trigger: true
      resource: time-rotor-config
    - get: bosh-stemcell
      resource: aws-stemcell
    - get: cf-release
      passed: [deliver]
      # manifest generation depends on loggregator submodule
      params: {submodules: [src/loggregator]}
      trigger: true
    - get: cf-mysql-release
      params: {submodules: none}
      passed: [deliver]
      trigger: true
    - get: cf-mysql-release-tarball
      passed: [deliver]
    - get: cf-dev-release
      passed: [deliver]
      trigger: true
    - get: garden-runc-release-tarball
      passed: [deliver]
      trigger: true
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [deliver]
      trigger: true
    - get: diego-dev-release
      passed: [deliver]
      trigger: true
  - task: generate-deployment-manifests
    file: diego-ci/concourse/generate_deployment_manifests.build.yml
    params:
      ENVIRONMENT_NAME: time-rotor
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-cf-datadog-start
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: cf
  - put: time-rotor-cf-deployment
    params:
      manifest: generated-manifest/cf-deployment.yml
      releases: [cf-dev-release/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: cf
  - task: generate-mysql-deployment-manifest
    file: diego-ci/concourse/generate_mysql_deployment_manifest.build.yml
    params:
      ENVIRONMENT_NAME: time-rotor
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - task: emit-mysql-datadog-start
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: mysql
  - put: time-rotor-mysql-deployment
    params:
      manifest: generated-manifest/mysql-deployment.yml
      releases: [cf-mysql-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-mysql-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: mysql
  - task: emit-diego-datadog-started
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: started
      DEPLOYMENT: diego
  - task: generate-deployment-manifests
    file: diego-ci/concourse/generate_deployment_manifests.build.yml
    params:
      ENVIRONMENT_NAME: time-rotor
      INFRASTRUCTURE: aws
      DEPLOYMENTS_DIR: deployments-diego
  - put: time-rotor-diego-deployment
    params:
      manifest: generated-manifest/diego-deployment.yml
      releases: [cf-dev-release/*.tgz, diego-dev-release/*.tgz, garden-runc-release-tarball/*.tgz, cflinuxfs2-rootfs-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: emit-datadog-finished
    file: diego-ci/concourse/emit_datadog_event.build.yml
    params:
      ENVIRONMENT: time-rotor
      DATADOG_API_KEY: {{datadog-api-key}}
      STATE: finished
      DEPLOYMENT: diego

- name: time-rotor-mysql-deploy
  plan:


- name: time-rotor-benchmark-bbs-tests
  serial_groups: [time-rotor-benchmark]
  plan:
  - aggregate:
    - get: 4hours
      trigger: true
    - get: diego-ci
    - get: deployments-diego
      resource: time-rotor-config
      passed: [time-rotor-deploy]
    - get: bosh-stemcell
      resource: aws-stemcell
      passed: [time-rotor-deploy]
    - get: time-rotor-diego-deployment
      passed: [time-rotor-deploy]
      trigger: true
    - get: diego-release
      passed: [time-rotor-deploy]
      params: {submodules: none}
  - task: generate-manifest
    file: diego-ci/concourse/generate_benchmarks_manifest.build.yml
    params:
      BOSH_PASSWORD: {{time-rotor-director-password}}
      BOSH_TARGET: bosh.time-rotor.cf-app.com
      BOSH_USER: admin
      DIEGO_DEPLOYMENT: cf-time-rotor-diego
      DEPLOYMENTS_DIR: deployments-diego
      ENVIRONMENT: time-rotor
  - put: time-rotor-benchmark-bbs-deployment
    params:
      manifest: generated-manifest/benchmarks.yml
      releases: []
      stemcells: [bosh-stemcell/*.tgz]
  - task: run
    file: diego-ci/concourse/run_errand.build.yml
    params:
      BOSH_PASSWORD: {{time-rotor-director-password}}
      BOSH_TARGET: bosh.time-rotor.cf-app.com
      BOSH_USER: admin
      MANIFEST: generated-manifest/benchmarks.yml
      ERRAND: benchmark-bbs
    ensure:
      put: diego-trace-time-rotor-benchmark-logs
      params:
        file: errand-results/benchmark-bbs*.tgz

- name: dusts-provision-periodic
  serial_groups: [dusts]
  plan:
  - aggregate:
    - get: sunday-morning
      trigger: true
    - get: deployments-diego
    - get: diego-ci
    - get: bosh-lite
    - get: diego-release-tarball
      resource: diego-dev-release
      passed: [candidate]
    - get: cf-release-tarball
      resource: cf-dev-release
      passed: [candidate]
    - get: cf-mysql-release
      params: {submodules: none}
    - get: cf-mysql-release-tarball
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: diego-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: diego-stable-release
      resource: diego-stable-release-mysql
      params: {submodules: none}
    - get: cf-stable-release
      resource: cf-stable-release-mysql
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
  - task: deprovision-bosh-lite
    file: diego-ci/concourse/deprovision_bosh_lite.yml
    params:
      ENVIRONMENT: diego-ci
      DEPLOYMENTS_DIR: deployments-diego
      BOSH_LITE_NAME: dusts
  - task: provision-bosh-lite
    file: diego-ci/concourse/provision_bosh_lite.yml
    params:
      ENVIRONMENT: diego-ci
      DEPLOYMENTS_DIR: deployments-diego
      DOMAIN: dusts.diego-ci.cf-app.com
      BOSH_LITE_NAME: dusts
      BOSH_LITE_PRIVATE_IP: 10.0.128.12
      BOSH_LITE_KEYPAIR: keypair-4ba032f6-b9a5-d86c-fac9-c70f26374cf2
  - task: upload-dusts-releases
    file: diego-ci/concourse/upload_dusts_releases.yml
    params:
      CF_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cf-release?v=247
      DIEGO_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/diego-release?v=1.0.0
      GARDEN_RUNC_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/garden-runc-release?v=1.0.3
      ROOTFS_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cflinuxfs2-rootfs-release?v=1.40.0
      CF_RELEASE_VPRIME: cf-release-tarball/*.tgz
      DIEGO_RELEASE_VPRIME: diego-release-tarball/*.tgz
      GARDEN_RUNC_RELEASE_VPRIME: garden-runc-release-tarball/*.tgz
      CF_MYSQL_RELEASE_VPRIME: cf-mysql-release-tarball/*.tgz
      ROOTFS_RELEASE_VPRIME: cflinuxfs2-rootfs-release-tarball/*.tgz
      BOSH_STEMCELL: https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent
      DOMAIN: bosh.dusts.diego-ci.cf-app.com
  - task: run-dusts
    params:
      DIRECTOR_IP: bosh.dusts.diego-ci.cf-app.com
      DOMAIN: dusts.diego-ci.cf-app.com
      DIEGO_RELEASE_V0_LEGACY: false
      USE_SQL_V0: true
    file: diego-ci/concourse/run_dusts_bosh_lite.yml

- name: dusts
  serial_groups: [dusts]
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: deployments-diego
    - get: diego-ci
    - get: bosh-lite
    - get: diego-release-tarball
      resource: diego-dev-release
      passed: [candidate]
    - get: cf-release-tarball
      resource: cf-dev-release
      passed: [candidate]
    - get: cf-mysql-release
      params: {submodules: none}
    - get: cf-mysql-release-tarball
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: diego-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: diego-stable-release
      resource: diego-stable-release-mysql
      params: {submodules: none}
    - get: cf-stable-release
      resource: cf-stable-release-mysql
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
  - task: upload-dusts-releases
    file: diego-ci/concourse/upload_dusts_releases.yml
    params:
      CF_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cf-release?v=247
      DIEGO_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/diego-release?v=1.0.0
      GARDEN_RUNC_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/garden-runc-release?v=1.0.3
      ROOTFS_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cflinuxfs2-rootfs-release?v=1.40.0
      CF_RELEASE_VPRIME: cf-release-tarball/*.tgz
      DIEGO_RELEASE_VPRIME: diego-release-tarball/*.tgz
      GARDEN_RUNC_RELEASE_VPRIME: garden-runc-release-tarball/*.tgz
      CF_MYSQL_RELEASE_VPRIME: cf-mysql-release-tarball/*.tgz
      ROOTFS_RELEASE_VPRIME: cflinuxfs2-rootfs-release-tarball/*.tgz
      BOSH_STEMCELL: https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent
      DOMAIN: dusts.diego-ci.cf-app.com
  - task: run-dusts
    params:
      DIRECTOR_IP: bosh.dusts.diego-ci.cf-app.com
      DOMAIN: dusts.diego-ci.cf-app.com
      DIEGO_RELEASE_V0_LEGACY: false
      USE_SQL_V0: true
    file: diego-ci/concourse/run_dusts_bosh_lite.yml

- name: dusts-etcd2sql-provision-periodic
  serial_groups: [dusts-etcd2sql]
  plan:
  - aggregate:
    - get: sunday-morning
      trigger: true
    - get: deployments-diego
    - get: diego-ci
    - get: bosh-lite
    - get: diego-release-tarball
      resource: diego-dev-release
      passed: [candidate]
    - get: cf-release-tarball
      resource: cf-dev-release
      passed: [candidate]
    - get: cf-mysql-release
      params: {submodules: none}
    - get: cf-mysql-release-tarball
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: etcd-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: diego-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: diego-stable-release
      params: {submodules: none}
    - get: cf-stable-release
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
  - task: deprovision-bosh-lite
    file: diego-ci/concourse/deprovision_bosh_lite.yml
    params:
      ENVIRONMENT: diego-ci
      DEPLOYMENTS_DIR: deployments-diego
      BOSH_LITE_NAME: dusts-etcd2sql
  - task: provision-bosh-lite
    file: diego-ci/concourse/provision_bosh_lite.yml
    params:
      ENVIRONMENT: diego-ci
      DEPLOYMENTS_DIR: deployments-diego
      DOMAIN: dusts-etcd2sql.diego-ci.cf-app.com
      BOSH_LITE_NAME: dusts-etcd2sql
      BOSH_LITE_PRIVATE_IP: 10.0.128.11
      BOSH_LITE_KEYPAIR: keypair-4ba032f6-b9a5-d86c-fac9-c70f26374cf2
  - task: upload-dusts-etcd2sql-releases
    file: diego-ci/concourse/upload_dusts_etcd2sql_releases.yml
    params:
      CF_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cf-release?v=226
      DIEGO_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/diego-release?v=0.1442.0
      GARDEN_LINUX_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry-incubator/garden-linux-release?v=0.328.0
      ETCD_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry-incubator/etcd-release?v=18
      CF_RELEASE_VPRIME: cf-release-tarball/*.tgz
      DIEGO_RELEASE_VPRIME: diego-release-tarball/*.tgz
      GARDEN_RUNC_RELEASE_VPRIME: garden-runc-release-tarball/*.tgz
      ETCD_RELEASE_VPRIME: etcd-release-tarball/*.tgz
      CF_MYSQL_RELEASE_VPRIME: cf-mysql-release-tarball/*.tgz
      ROOTFS_RELEASE_VPRIME: cflinuxfs2-rootfs-release-tarball/*.tgz
      BOSH_STEMCELL: https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent
      DOMAIN: dusts-etcd2sql.diego-ci.cf-app.com
  - task: run-dusts
    params:
      DIRECTOR_IP: bosh.dusts-etcd2sql.diego-ci.cf-app.com
      DOMAIN: dusts-etcd2sql.diego-ci.cf-app.com
    file: diego-ci/concourse/run_dusts_bosh_lite.yml

- name: dusts-etcd2sql
  serial_groups: [dusts-etcd2sql]
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - aggregate:
    - get: deployments-diego
    - get: diego-ci
    - get: bosh-lite
    - get: diego-release-tarball
      resource: diego-dev-release
      passed: [candidate]
      trigger: true
    - get: cf-release-tarball
      resource: cf-dev-release
      passed: [candidate]
    - get: cf-mysql-release
      params: {submodules: none}
    - get: cf-mysql-release-tarball
      passed: [candidate]
    - get: garden-runc-release-tarball
      passed: [candidate]
    - get: etcd-release-tarball
      passed: [candidate]
    - get: cflinuxfs2-rootfs-release-tarball
      passed: [candidate]
    - get: diego-release
      passed: [candidate]
    - get: cf-release
      passed: [candidate]
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
    - get: diego-stable-release
      params: {submodules: none}
    - get: cf-stable-release
      params: {submodules: [src/loggregator]} # needed for cf-lamb template
  - task: upload-dusts-etcd2sql-releases
    file: diego-ci/concourse/upload_dusts_etcd2sql_releases.yml
    params:
      CF_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/cf-release?v=226
      DIEGO_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry/diego-release?v=0.1442.0
      GARDEN_LINUX_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry-incubator/garden-linux-release?v=0.328.0
      ETCD_RELEASE_V0: https://bosh.io/d/github.com/cloudfoundry-incubator/etcd-release?v=18
      CF_RELEASE_VPRIME: cf-release-tarball/*.tgz
      DIEGO_RELEASE_VPRIME: diego-release-tarball/*.tgz
      GARDEN_RUNC_RELEASE_VPRIME: garden-runc-release-tarball/*.tgz
      ETCD_RELEASE_VPRIME: etcd-release-tarball/*.tgz
      CF_MYSQL_RELEASE_VPRIME: cf-mysql-release-tarball/*.tgz
      ROOTFS_RELEASE_VPRIME: cflinuxfs2-rootfs-release-tarball/*.tgz
      BOSH_STEMCELL: https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent
      DOMAIN: dusts-etcd2sql.diego-ci.cf-app.com
  - task: run-dusts
    params:
      DIRECTOR_IP: bosh.dusts-etcd2sql.diego-ci.cf-app.com
      DOMAIN: dusts-etcd2sql.diego-ci.cf-app.com
    file: diego-ci/concourse/run_dusts_bosh_lite.yml

resources:
- name: 30min
  type: time
  source:
    interval: 30m

- name: 4hours
  type: time
  source:
    interval: 4h

- name: daily
  type: time
  source:
    interval: 24h

- name: sunday-morning
  type: time
  source:
    start: 0:00 -0800
    stop: 1:00 -0800
    days:
      - Sunday

- name: aws-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent

- name: aws-windows-stemcell
  type: s3
  source:
    bucket: bosh-windows-stemcells
    regexp: light-bosh-stemcell-(.*)-aws-xen-hvm-windows2012R2-go_agent.tgz

- name: time-rotor-config
  type: git
  source:
    paths:
    - time-rotor
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: electron-cannon-config
  type: git
  source:
    paths:
    - electron-cannon
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: ketchup-config
  type: git
  source:
    paths:
    - ketchup
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: ketchup-cats-config
  type: git
  source:
    paths:
    - ketchup/integration_config.json
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: electron-cannon-cats-config
  type: git
  source:
    paths:
    - electron-cannon/integration_config.json
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: runtime-credentials
  type: git
  source:
    uri: git@github.com:cloudfoundry/runtime-credentials.git
    private_key: {{cf-diego-private-key}}

- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git

- name: diego-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/diego-ci

- name: deployments-diego
  type: git
  source:
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: {{cf-diego-private-key}}

- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment.git

- name: cf-release
  type: git
  source:
    branch: release-candidate
    uri: https://github.com/cloudfoundry/cf-release.git

- name: cf-mysql-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-mysql-release.git

- name: cf-dev-release
  type: s3
  source:
    bucket: cf-dev-releases
    regexp: cf-dev-release-(.*).tgz
    access_key_id: {{aws-diego-pipeline-access-key-id}}
    secret_access_key: {{aws-diego-pipeline-secret-access-key}}

- name: diego-dev-release
  type: s3
  source:
    bucket: diego-dev-releases
    regexp: diego-(.*).tgz
    access_key_id: {{aws-diego-pipeline-access-key-id}}
    secret_access_key: {{aws-diego-pipeline-secret-access-key}}

- name: diego-release
  type: git
  source:
    branch: develop
    fetch: ["master"]
    ignore_paths:
      - dev_releases
      - git-hooks
      - releases
      - .final_builds
    uri: git@github.com:cloudfoundry/diego-release.git
    private_key: {{cf-diego-private-key}}

- name: wats
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/wats

- name: greenhouse-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/greenhouse-ci.git

- name: version
  type: semver
  source:
    access_key_id: {{aws-diego-pipeline-access-key-id}}
    secret_access_key: {{aws-diego-pipeline-secret-access-key}}
    bucket: diego-release-versions
    initial_version: 0.1000.0
    key: current-version
    region_name: us-east-1

- name: ketchup-cf-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup
    ignore_ssl: true

- name: ketchup-diego-funky-cells-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup-diego-funky-cells
    ignore_ssl: true

- name: ketchup-diego-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup-diego
    ignore_ssl: true

- name: ketchup-diego-windows-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup-diego-windows
    ignore_ssl: true

- name: ketchup-vizzini-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup-diego-vizzini
    ignore_ssl: true

- name: ketchup-mysql-deployment
  type: bosh-deployment
  source:
    target: https://bosh.ketchup.cf-app.com:25555
    username: admin
    password: {{ketchup-director-password}}
    deployment: cf-ketchup-mysql
    ignore_ssl: true

- name: time-rotor-mysql-deployment
  type: bosh-deployment
  source:
    target: https://bosh.time-rotor.cf-app.com:25555
    username: admin
    password: {{time-rotor-director-password}}
    deployment: time-rotor-mysql
    ignore_ssl: true

- name: time-rotor-cf-deployment
  type: bosh-deployment
  source:
    target: https://bosh.time-rotor.cf-app.com:25555
    username: admin
    password: {{time-rotor-director-password}}
    deployment: cf-time-rotor
    ignore_ssl: true

- name: time-rotor-diego-deployment
  type: bosh-deployment
  source:
    target: https://bosh.time-rotor.cf-app.com:25555
    username: admin
    password: {{time-rotor-director-password}}
    deployment: cf-time-rotor-diego
    ignore_ssl: true

- name: time-rotor-benchmark-bbs-deployment
  type: bosh-deployment
  source:
    target: https://bosh.time-rotor.cf-app.com:25555
    username: admin
    password: {{time-rotor-director-password}}
    deployment: diego-benchmarks
    ignore_ssl: true

- name: diego-final-releases
  type: s3
  source:
    bucket: diego-final-releases
    regexp: diego-(.*).tgz
    access_key_id: {{aws-diego-final-release-access-key-id}}
    secret_access_key: {{aws-diego-final-release-secret-access-key}}

- name: diego-trace-ketchup-smoke-logs
  type: s3
  source:
    bucket: diego-trace-logs
    regexp: ketchup-smoke-tests/smoke_tests\.(0\.0\.0)\.[\d\.\-]+.tgz
    access_key_id: {{aws-diego-pipeline-access-key-id}}
    secret_access_key: {{aws-diego-pipeline-secret-access-key}}

- name: diego-trace-time-rotor-benchmark-logs
  type: s3
  source:
    bucket: diego-trace-logs
    regexp: time-rotor-benchmarks/benchmark-bbs\.(0\.0\.0)\.[\d\.\-]+.tgz
    access_key_id: {{aws-diego-pipeline-access-key-id}}
    secret_access_key: {{aws-diego-pipeline-secret-access-key}}

- name: diego-release-release-candidate
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: release-candidate
    private_key: {{cf-diego-private-key}}

- name: diego-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: master
    private_key: {{cf-diego-private-key}}

- name: diego-release-mergeback
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: develop
    private_key: {{cf-diego-private-key}}

- name: candidate-lock
  type: pool
  source:
    uri: git@github.com:cloudfoundry/diego-ci-pools.git
    branch: master
    pool: candidate-lock
    private_key: {{cf-diego-private-key}}

- name: tracker
  type: tracker
  source:
    tracker_url: https://www.pivotaltracker.com
    project_id: "1003146"
    token: {{tracker-token}}

- name: cf-mysql-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-mysql-release

- name: cflinuxfs2-rootfs-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry/cflinuxfs2-rootfs-release

- name: etcd-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/etcd-release

- name: garden-windows-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/garden-windows-bosh-release
    version: 0.0.9

- name: garden-runc-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release

- name: garden-runc-release-master
  type: git
  source:
    uri: https://github.com/cloudfoundry/garden-runc-release
    branch: master

- name: github-release
  type: github-release
  source:
    user: cloudfoundry
    repository: diego-release
    drafts: true
    # personal access token for ematpl
    access_token: {{emalm-personal-access-token}}

- name: bosh-lite
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-lite.git

- name: diego-stable-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/diego-release.git
    branch: v0.1442.0

- name: diego-stable-release-mysql
  type: git
  source:
    uri: https://github.com/cloudfoundry/diego-release.git
    branch: v1.0.0

- name: cf-stable-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-release.git
    branch: v226

- name: cf-stable-release-mysql
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-release.git
    branch: v247

- name: diegocanaryapp
  type: git
  source:
    uri: https://github.com/cloudfoundry/diegocanaryapp.git
