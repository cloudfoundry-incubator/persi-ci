#!/bin/bash -e

function finish {
  pkill ssh || true
}
trap finish EXIT

generate_nfs_vars() {
  source persi-ci/scripts/ci/bbl_get_bosh_env
  source bosh-env/set-env.sh
    cat << EOF > ${ROOT_DIR}/generated-vars/nfs-vars.yml
---
nfs-ldap-service-user: ${LDAP_SVC_USER}
nfs-ldap-service-password: ${LDAP_SVC_PASS}
nfs-ldap-host: ${LDAP_HOST}
nfs-ldap-port: ${LDAP_PORT}
nfs-ldap-proto: ${LDAP_PROTO}
nfs-ldap-fqdn: ${LDAP_USER_FQDN}

nfstestserver_static_ips: ${NFSTESTSERVER_STATIC_IP}
nfstestservertwo_static_ips: ${NFSTESTSERVER_TWO_STATIC_IP}
nfstestldapserver_static_ips: ${NFSTESTLDAPSERVER_STATIC_IP}
EOF
}

generate_smb_vars() {
    cat << EOF > ${ROOT_DIR}/generated-vars/smb-vars.yml
---
smb-username: ${SMB_USERNAME}
smb-password: ${SMB_PASSWORD}
EOF
}

main() {
  ROOT_DIR="${1}"
  mkdir -p ${ROOT_DIR}/generated-vars

  apt-get install -y python3-pip
  pip3 install yq

  if [ "$GENERATE_NFS_VARS" = "true" ]; then
    generate_nfs_vars
  fi

  if [ "$GENERATE_SMB_VARS" = "true" ]; then
    generate_smb_vars
  fi
}

main ${PWD}
