#!/bin/bash -eu

set -e -x

source bosh-env/set-env.sh

export CA_CERT="$PWD/bosh-env/ca-cert.pem"
#export BBR_PRIVATE_KEY=$(cat bosh-env/ssh-key)

export DEPLOYMENT_TO_BACKUP=cf
export DEPLOYMENT_TO_RESTORE=cf
export BOSH_URL=${BOSH_ENVIRONMENT}
export BOSH_CLIENT=${BOSH_CLIENT}
export BOSH_CLIENT_SECRET=${BOSH_CLIENT_SECRET}
export BOSH_CERT_PATH=${CA_CERT}
export BBR_BUILD_PATH=binary/bbr

# install glide because drats doesn't
curl https://glide.sh/get | sh

# make a go project
mkdir -p runme
pushd runme/
    export GOPATH=$PWD
    export PATH=$GOPATH/bin:$PATH

    go get github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests
popd

# run drats
pushd src/github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests/
    scripts/run_acceptance_tests.sh
popd