resources:
- name: nfs-volume-release
  type: git
  source:
    branch: {{lts-nfs-branch}}
    username: {{github-user}}
    password: {{github-password}}
    uri: https://github.com/cloudfoundry/nfs-volume-release.git

- name: nfs-volume-release-concourse-tasks
  type: git
  source:
    branch: {{lts-nfs-branch}}
    username: {{github-user}}
    password: {{github-password}}
    uri: https://github.com/cloudfoundry/nfs-volume-release.git
- name: mapfs-release
  type: git
  source:
    branch: master
    username: {{github-user}}
    password: {{github-password}}
    uri: https://github.com/cloudfoundry/mapfs-release.git

- name: mapfs-release-concourse-tasks
  type: git
  source:
    branch: master
    username: {{github-user}}
    password: {{github-password}}
    uri: https://github.com/cloudfoundry/mapfs-release.git

- name: nfsvolume-version
  type: semver
  source:
    access_key_id: {{lts-nfsvolume-uploader_aws_ID}}
    bucket: lts-nfsvolume-release-versions
    initial_version: {{nfs-semver-initial-version}}
    key: current-version
    region_name: us-west-2
    secret_access_key: {{lts-nfsvolume-uploader_aws_secret}}

# - name: nfs-driver-integration-tests-docker-image
#   type: docker-image
#   source:
#     repository: cfpersi/nfs-integration-tests
#     username: ((dockerhub_username))
#     password: ((dockerhub_password))

# - name: nfs-bosh-release-test-docker-image
#   type: docker-image
#   source:
#     repository: cfpersi/bosh-release-tests
#     username: ((dockerhub_username))
#     password: ((dockerhub_password))

# - name: nfs-broker-tests-docker-image
#   type: docker-image
#   source:
#     repository: cfpersi/nfs-broker-tests
#     username: ((dockerhub_username))
#     password: ((dockerhub_password))

# - name: nfs-unit-tests-docker-image
#   type: docker-image
#   source:
#     repository: cfpersi/nfs-unit-tests
#     username: ((dockerhub_username))
#     password: ((dockerhub_password))

# - name: nfs-cats-docker-image
#   type: docker-image
#   source:
#     repository: cfpersi/nfs-cats
#     username: ((dockerhub_username))
#     password: ((dockerhub_password))

- name: persi-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/persi-ci.git

# - name: cf-volume-services-acceptance-tests
#   type: git
#   source:
#     uri: https://github.com/cloudfoundry/cf-volume-services-acceptance-tests.git

# - name: cf-acceptance-tests
#   type: git
#   source:
#     branch: develop
#     uri: https://github.com/lisamcho/cf-acceptance-tests.git

- name: docker_driver_integration_tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/docker_driver_integration_tests

- name: credhub
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/credhub

- name: nfs-volume-release-tarball
  type: s3
  source:
    access_key_id: {{lts-nfsvolume-uploader_aws_ID}}
    bucket: nfs-volume-release-tarballs
    regexp: nfs-volume-(.*).tgz
    secret_access_key: {{lts-nfsvolume-uploader_aws_secret}}

jobs:
- name: nfs-security-scan
  plan:
    - in_parallel:
        - get: persi-ci
        - get: nfs-volume-release
          trigger: true
    - task: build
      file: persi-ci/scripts/ci/security-scan.build.yml
      params:
        PATHS: "src/code.cloudfoundry.org/nfsv3driver/:src/code.cloudfoundry.org/nfsbroker/"
        RELEASE_DIR: nfs-volume-release
      input_mapping:
        release-dir: nfs-volume-release

- name: nfsdriver-unit
  public: true
  plan:
  - in_parallel:
    - get: nfs-volume-release-concourse-tasks
      params:
        submodules: none
    - get: nfs-volume-release
      trigger: true
  - task: build
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_driver_unit.build.yml

- name: nfsbroker-tests
  public: true
  plan:
  - in_parallel:
      fail_fast: true
      steps:
      - get: nfs-volume-release-concourse-tasks
        params:
          submodules: none
      - get: nfs-volume-release
        trigger: true
      - get: credhub
  - task: run-test
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_broker_integration.build.yml

- name: nfs-volume-release-job-tests
  plan:
  - in_parallel:
      fail_fast: true
      steps:
      - get: persi-ci
      - get: nfs-volume-release-concourse-tasks
      - get: mapfs-release
      - get: nfs-volume-release
        trigger: true
  - task: rspec
    file: persi-ci/scripts/ci/run-rspec.build.yml
    input_mapping:
      test-repo: nfs-volume-release
  - task: bosh-release-test
    attempts: 3
    file: nfs-volume-release-concourse-tasks/scripts/ci/run_bosh_release_tests.build.yml
    privileged: true

- name: mapfs-security-scan
  plan:
    - in_parallel:
        - get: persi-ci
        - get: mapfs-release
          trigger: true
    - task: build
      file: persi-ci/scripts/ci/security-scan.build.yml
      params:
        PATHS: "src/mapfs/"
      input_mapping:
        release-dir: mapfs-release

- name: mapfs-release-job-tests
  plan:
  - in_parallel:
      fail_fast: true
      steps:
      - get: mapfs-release
        trigger: true
      - get: mapfs-release-concourse-tasks
  - task: bosh-release-test
    file: mapfs-release-concourse-tasks/scripts/ci/run_bosh_release_tests.build.yml
    privileged: true
    timeout: 1h


- name: nfsdriver-integration
  serial: true
  plan:
  - in_parallel:
      fail_fast: true
      steps:
      - get: persi-ci
      - get: docker_driver_integration_tests
      - get: nfs-volume-release-concourse-tasks
        params:
          submodules: none
      - get: nfs-volume-release
        passed:
        - nfsdriver-unit
        - nfsbroker-tests
        trigger: true
      - get: mapfs-release
        trigger: true
  - in_parallel:
      fail_fast: true
      steps:
      - task: run_docker_driver_integration_tests
        file: nfs-volume-release-concourse-tasks/scripts/ci/run_docker_driver_integration_tests.build.yml
        privileged: true
        params:
          TEST_PACKAGE: docker_driver_integration_tests/
      - task: run_docker_driver_lazy_unmount_integration_tests
        file: nfs-volume-release-concourse-tasks/scripts/ci/run_docker_driver_integration_tests.build.yml
        privileged: true
        params:
          TEST_PACKAGE: docker_driver_integration_tests/lazy_unmount
      - task: run_driver_broker_compatibility_tests
        privileged: true
        input_mapping:
          director-state: bbl-state
        params:
          TEST_PACKAGE: docker_driver_integration_tests/compatibility
        file: nfs-volume-release-concourse-tasks/scripts/ci/run_docker_driver_integration_tests.build.yml

- name: create-nfs-volume-release
  serial_groups:
  - nfs-version
  plan:
  - in_parallel:
      fail_fast: true
      steps:
      - get: nfs-volume-release
        passed:
        - nfsdriver-integration
        - nfs-volume-release-job-tests
        trigger: true
      - get: nfs-volume-version
        resource: nfsvolume-version
        params:
          pre: rc
      - get: persi-ci
  - put: nfs-volume-version
    resource: nfsvolume-version
    params:
      file: nfs-volume-version/number
  - task: create-release
    file: persi-ci/scripts/ci/create-release.build.yml
    input_mapping:
      release: nfs-volume-release
      release-version: nfs-volume-version
    params:
      RELEASE_NAME: nfs-volume
  - put: nfs-volume-release-tarball
    params:
      file: release-tarball/nfs-volume-*.tgz

